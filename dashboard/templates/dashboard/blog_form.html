{% extends 'dashboard/base_daisyui.html' %}

{% block title %}{{ action }} Blog Post{% endblock %}

{% block dashboard_content %}
<div class="max-w-7xl mx-auto">
    <!-- Breadcrumb -->
    <div class="text-sm breadcrumbs mb-6">
        <ul>
            <li><a href="{% url 'dashboard:home' %}">Dashboard</a></li>
            <li><a href="{% url 'dashboard:blog_list' %}">Blog Posts</a></li>
            {% if action == "Edit" %}
                <li><a href="{% url 'dashboard:blog_detail' post.pk %}">{{ post.title }}</a></li>
                <li>Edit</li>
            {% else %}
                <li>Create New</li>
            {% endif %}
        </ul>
    </div>
    
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold">{{ action }} Blog Post</h1>
        <p class="text-base-content/60 mt-2">
            {% if action == "Edit" %}
                Update your blog post content and settings
            {% else %}
                Create a new blog post with rich content and SEO settings
            {% endif %}
        </p>
    </div>

    <!-- Form -->
    <form method="POST" enctype="multipart/form-data" class="space-y-6">
        {% csrf_token %}
        
        {% if form.non_field_errors %}
        <div class="alert alert-error">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <div>
                <h3 class="font-bold">There were errors with your submission</h3>
                <div class="text-sm">{{ form.non_field_errors }}</div>
            </div>
        </div>
        {% endif %}
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Main Content Area -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Post Information -->
                <div class="card bg-base-100 shadow-xl">
                    <div class="card-body">
                        <h2 class="card-title mb-4">Post Information</h2>
                        
                        <div class="space-y-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Title <span class="text-error">*</span></span>
                                </label>
                                {{ form.title }}
                                {% if form.title.errors %}
                                    <label class="label">
                                        <span class="label-text-alt text-error">{{ form.title.errors.0 }}</span>
                                    </label>
                                {% endif %}
                            </div>
                            
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Slug</span>
                                    <span class="label-text-alt">Leave empty to auto-generate from title</span>
                                </label>
                                {{ form.slug }}
                                {% if form.slug.errors %}
                                    <label class="label">
                                        <span class="label-text-alt text-error">{{ form.slug.errors.0 }}</span>
                                    </label>
                                {% endif %}
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Category</span>
                                    </label>
                                    {{ form.category }}
                                    {% if form.category.errors %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ form.category.errors.0 }}</span>
                                        </label>
                                    {% endif %}
                                </div>
                                
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Status</span>
                                    </label>
                                    {{ form.status }}
                                    {% if form.status.errors %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ form.status.errors.0 }}</span>
                                        </label>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Excerpt</span>
                                    <span class="label-text-alt">Brief summary of the post</span>
                                </label>
                                {{ form.excerpt }}
                                {% if form.excerpt.errors %}
                                    <label class="label">
                                        <span class="label-text-alt text-error">{{ form.excerpt.errors.0 }}</span>
                                    </label>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Content -->
                <div class="card bg-base-100 shadow-xl">
                    <div class="card-body">
                        <h2 class="card-title mb-4">Content</h2>
                        
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Post Content <span class="text-error">*</span></span>
                            </label>
                            {{ form.content }}
                            {% if form.content.errors %}
                                <label class="label">
                                    <span class="label-text-alt text-error">{{ form.content.errors.0 }}</span>
                                </label>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
                
            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Publish Settings -->
                <div class="card bg-base-100 shadow-xl">
                    <div class="card-body">
                        <h2 class="card-title mb-4">Publish Settings</h2>
                        
                        <div class="space-y-4">
                            <div class="form-control">
                                <label class="label cursor-pointer justify-start gap-4">
                                    {{ form.featured }}
                                    <span class="label-text">Featured Post</span>
                                </label>
                            </div>
                            
                            <div class="form-control">
                                <label class="label cursor-pointer justify-start gap-4">
                                    {{ form.allow_comments }}
                                    <span class="label-text">Allow Comments</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                    
                <!-- Featured Image -->
                <div class="card bg-base-100 shadow-xl">
                    <div class="card-body">
                        <h2 class="card-title mb-4">Featured Image</h2>
                        
                        {% if post and post.featured_image %}
                            <div class="mb-4">
                                <figure class="rounded-lg overflow-hidden">
                                    <img src="{{ post.featured_image.url }}" alt="Current featured image" class="w-full">
                                </figure>
                                <p class="text-sm text-base-content/60 mt-2">Current image</p>
                            </div>
                        {% endif %}
                        
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Upload Image</span>
                                <span class="label-text-alt">Upload a featured image for the post</span>
                            </label>
                            <input type="file" name="{{ form.featured_image.name }}" class="file-input file-input-bordered w-full" {% if form.featured_image.value %}value="{{ form.featured_image.value }}"{% endif %}>
                            {% if form.featured_image.errors %}
                                <label class="label">
                                    <span class="label-text-alt text-error">{{ form.featured_image.errors.0 }}</span>
                                </label>
                            {% endif %}
                        </div>
                    </div>
                </div>
                    
                <!-- Tags -->
                <div class="card bg-base-100 shadow-xl">
                    <div class="card-body">
                        <h2 class="card-title mb-4">Tags</h2>
                        
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Select Tags</span>
                                <span class="label-text-alt">Select relevant tags for the post</span>
                            </label>
                            {{ form.tags }}
                            {% if form.tags.errors %}
                                <label class="label">
                                    <span class="label-text-alt text-error">{{ form.tags.errors.0 }}</span>
                                </label>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Product Integration -->
                <div class="card bg-gradient-to-br from-info/10 to-primary/10 shadow-xl">
                    <div class="card-body">
                        <div class="flex items-center gap-2 mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-info" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                            </svg>
                            <h2 class="card-title">Product Integration</h2>
                            <div class="badge badge-info badge-outline badge-sm ml-auto">Optional</div>
                        </div>
                        
                        <p class="text-sm text-base-content/70 mb-4">
                            Link products to showcase with this article
                        </p>
                        
                        <div class="space-y-4">
                            <!-- Product Category -->
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Product Category</span>
                                </label>
                                {{ form.product_category }}
                                {% if form.product_category.help_text %}
                                    <label class="label">
                                        <span class="label-text-alt">{{ form.product_category.help_text }}</span>
                                    </label>
                                {% endif %}
                                {% if form.product_category.errors %}
                                    <label class="label">
                                        <span class="label-text-alt text-error">{{ form.product_category.errors.0 }}</span>
                                    </label>
                                {% endif %}
                            </div>
                            
                            <!-- Related Products -->
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Related Products</span>
                                    <span class="label-text-alt">
                                        <kbd class="kbd kbd-xs">Ctrl</kbd>+Click
                                    </span>
                                </label>
                                {{ form.related_products }}
                                {% if form.related_products.help_text %}
                                    <label class="label">
                                        <span class="label-text-alt">{{ form.related_products.help_text }}</span>
                                    </label>
                                {% endif %}
                                {% if form.related_products.errors %}
                                    <label class="label">
                                        <span class="label-text-alt text-error">{{ form.related_products.errors.0 }}</span>
                                    </label>
                                {% endif %}
                                
                                <!-- Show selected products if editing -->
                                {% if post and post.related_products.exists %}
                                <div class="mt-2">
                                    <p class="text-xs text-base-content/60 mb-1">Currently selected:</p>
                                    <div class="flex flex-wrap gap-1">
                                        {% for product in post.related_products.all %}
                                            <span class="badge badge-info badge-sm">{{ product.name }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                    
            </div>
        </div>
            
        <!-- Form Actions -->
        <div class="flex justify-end gap-3">
            <button type="button" onclick="window.history.back()" class="btn btn-ghost">
                Cancel
            </button>
            <button type="submit" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                {% if action == "Edit" %}Save Changes{% else %}Create Post{% endif %}
            </button>
        </div>
    </form>
</div>

<style>
    /* Add DaisyUI styling to Django form fields */
    input[type="text"]:not(.input),
    input[type="email"]:not(.input),
    input[type="tel"]:not(.input),
    input[type="number"]:not(.input),
    input[type="password"]:not(.input),
    input[type="date"]:not(.input),
    input[type="datetime-local"]:not(.input),
    input[type="time"]:not(.input),
    input[type="url"]:not(.input),
    input[type="search"]:not(.input) {
        @apply input input-bordered w-full;
    }
    
    select:not(.select) {
        @apply select select-bordered w-full;
    }
    
    select[multiple]:not(.select) {
        @apply select select-bordered w-full;
        min-height: 240px !important;
        height: 240px !important;
    }
    
    /* Specifically target the multi-select fields */
    #id_related_products {
        min-height: 240px !important;
        height: 240px !important;
    }
    
    #id_tags {
        min-height: 150px !important;
        height: 150px !important;
    }
    
    textarea:not(.textarea):not(.note-editable) {
        @apply textarea textarea-bordered w-full h-24;
    }
    
    input[type="checkbox"]:not(.checkbox) {
        @apply checkbox checkbox-primary;
    }
    
    input[type="radio"]:not(.radio) {
        @apply radio radio-primary;
    }
    
    /* Override Summernote styles */
    .note-editor.note-frame {
        @apply border border-base-300 rounded-lg !important;
    }
    
    .note-editor.note-frame .note-toolbar {
        @apply bg-base-200 border-b border-base-300 rounded-t-lg !important;
    }
    
    .note-editor.note-frame:focus-within {
        @apply border-primary ring-2 ring-primary/20 !important;
    }
    
    .note-editable {
        min-height: 400px !important;
        @apply p-4 text-sm !important;
    }
    
    /* Select2 override if used */
    .select2-container--default .select2-selection--multiple {
        @apply border border-base-300 rounded-lg min-h-[2.5rem] !important;
    }
    
    .select2-container--default.select2-container--focus .select2-selection--multiple {
        @apply border-primary ring-2 ring-primary/20 !important;
    }
</style>

<script>
$(document).ready(function() {
    // Initialize Summernote on the content field
    $('#id_content').summernote({
        height: 400,
        toolbar: [
            ['style', ['style']],
            ['font', ['bold', 'italic', 'underline', 'clear']],
            ['fontname', ['fontname']],
            ['fontsize', ['fontsize']],
            ['color', ['color']],
            ['para', ['ul', 'ol', 'paragraph']],
            ['table', ['table']],
            ['insert', ['link', 'picture', 'video']],
            ['view', ['fullscreen', 'codeview', 'help']]
        ]
    });
});
</script>
{% endblock %}