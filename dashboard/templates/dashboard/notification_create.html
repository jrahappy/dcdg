{% extends 'dashboard/base.html' %}

{% block page_title %}Create Notification{% endblock %}

{% block dashboard_content %}
<div class="h-full flex flex-col bg-white">
    <!-- Header -->
    <div class="flex items-center justify-between h-12 px-4 border-b border-gray-200 bg-white">
        <div class="flex items-center gap-3">
            <a href="{% url 'dashboard:notification_manage' %}" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1 class="text-lg font-semibold text-gray-900">Create Notification</h1>
        </div>
    </div>

    <!-- Form -->
    <div class="flex-1 overflow-y-auto p-6">
        <form method="post" class="max-w-4xl mx-auto">
            {% csrf_token %}
            
            <div class="space-y-6">
                <!-- Notification Details Section -->
                <div class="bg-gray-50 rounded-lg p-6">
                    <h2 class="text-lg font-medium text-gray-900 mb-4">Notification Details</h2>
                    
                    <div class="space-y-4">
                        <!-- Title -->
                        <div>
                            <label for="title" class="block text-sm font-medium text-gray-700 mb-1">
                                Title <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="title" name="title" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="Enter notification title">
                            <p class="mt-1 text-sm text-gray-500">This will be displayed as the notification heading</p>
                        </div>
                        
                        <!-- Type and Priority Row -->
                        <div class="grid grid-cols-2 gap-4">
                            <!-- Notification Type -->
                            <div>
                                <label for="notification_type" class="block text-sm font-medium text-gray-700 mb-1">
                                    Type <span class="text-red-500">*</span>
                                </label>
                                <select id="notification_type" name="notification_type" required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    {% for value, label in notification_types %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <!-- Priority -->
                            <div>
                                <label for="priority" class="block text-sm font-medium text-gray-700 mb-1">
                                    Priority <span class="text-red-500">*</span>
                                </label>
                                <select id="priority" name="priority" required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    {% for value, label in priority_levels %}
                                    <option value="{{ value }}" {% if value == 'medium' %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <!-- Message -->
                        <div>
                            <label for="message" class="block text-sm font-medium text-gray-700 mb-1">
                                Message <span class="text-red-500">*</span>
                            </label>
                            <textarea id="message" name="message" rows="4" required
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                      placeholder="Enter the notification message"></textarea>
                            <p class="mt-1 text-sm text-gray-500">The main content of the notification</p>
                        </div>
                        
                        <!-- Link (Optional) -->
                        <div>
                            <label for="link" class="block text-sm font-medium text-gray-700 mb-1">
                                Link (Optional)
                            </label>
                            <input type="url" id="link" name="link"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="https://example.com/order/123">
                            <p class="mt-1 text-sm text-gray-500">Optional link for the notification (e.g., to an order or product)</p>
                        </div>
                    </div>
                </div>
    
                <!-- Recipients Section -->
                <div class="bg-gray-50 rounded-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-medium text-gray-900">Select Recipients</h2>
                        <div class="flex gap-2">
                            <button type="button" onclick="selectAllUsers()"
                                    class="px-3 py-1 text-sm border border-gray-300 rounded-md hover:bg-gray-100">
                                Select All
                            </button>
                            <button type="button" onclick="deselectAllUsers()"
                                    class="px-3 py-1 text-sm border border-gray-300 rounded-md hover:bg-gray-100">
                                Deselect All
                            </button>
                        </div>
                    </div>
                    
                    <!-- Search Box -->
                    <div class="mb-3">
                        <input type="text" id="user-search"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Search users by name or email...">
                    </div>
                    
                    <!-- User List -->
                    <div class="border border-gray-200 rounded-md max-h-96 overflow-y-auto">
                        {% for user in users %}
                        <div class="user-item hover:bg-gray-50 border-b border-gray-100 last:border-b-0"
                             data-search="{{ user.get_full_name|lower }} {{ user.username|lower }} {{ user.email|lower }}">
                            <label class="flex items-center p-3 cursor-pointer">
                                <input type="checkbox" name="users" value="{{ user.pk }}"
                                       class="user-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <div class="ml-3 flex-1">
                                    <div class="text-sm font-medium text-gray-900">{{ user.get_full_name|default:user.username }}</div>
                                    <div class="text-sm text-gray-500">{{ user.email }}</div>
                                    {% if user.last_login %}
                                    <div class="text-xs text-gray-400 mt-1">Last login: {{ user.last_login|timesince }} ago</div>
                                    {% endif %}
                                </div>
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="mt-3 text-sm text-gray-500">
                        <span id="selected-count">0</span> users selected
                    </div>
                </div>
            </div>
            
            <!-- Form Actions -->
            <div class="mt-6 flex items-center justify-end gap-3">
                <a href="{% url 'dashboard:notification_manage' %}"
                   class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    Cancel
                </a>
                <button type="submit"
                        class="px-4 py-2 border border-transparent rounded-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                    <i class="fas fa-paper-plane mr-2"></i> Send Notification
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// User search functionality
document.getElementById('user-search').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const userItems = document.querySelectorAll('.user-item');
    
    userItems.forEach(item => {
        const searchText = item.dataset.search;
        if (searchText.includes(searchTerm)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
});

// Update selected count
function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.user-checkbox:checked');
    document.getElementById('selected-count').textContent = checkboxes.length;
}

document.querySelectorAll('.user-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', updateSelectedCount);
});

// Select/Deselect all
function selectAllUsers() {
    const visibleCheckboxes = document.querySelectorAll('.user-item:not([style*="display: none"]) .user-checkbox');
    visibleCheckboxes.forEach(checkbox => checkbox.checked = true);
    updateSelectedCount();
}

function deselectAllUsers() {
    document.querySelectorAll('.user-checkbox').forEach(checkbox => checkbox.checked = false);
    updateSelectedCount();
}

// Form validation
document.querySelector('.notification-form').addEventListener('submit', function(e) {
    const selectedUsers = document.querySelectorAll('.user-checkbox:checked');
    if (selectedUsers.length === 0) {
        e.preventDefault();
        alert('Please select at least one recipient');
        return false;
    }
});
</script>
{% endblock %}