{% extends 'dashboard/base_daisyui.html' %}

{% block title %}Select Customers for Target Group{% endblock %}

{% block dashboard_content %}
<div class="max-w-7xl mx-auto">
    <!-- Breadcrumb -->
    <div class="text-sm breadcrumbs mb-6">
        <ul>
            <li><a href="{% url 'dashboard:home' %}">Dashboard</a></li>
            <li><a href="{% url 'email_campaign:campaign_list' %}">Email Campaigns</a></li>
            <li>Select Customers</li>
        </ul>
    </div>
    
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold">Build Your Target Group</h1>
            <p class="text-base-content/60 mt-1">Filter and select customers to add to your email campaign target group</p>
        </div>
        <a href="{% url 'email_campaign:target_group_cart' %}" class="btn btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            Target Group Cart
            <div id="cart-count" class="badge badge-sm">{{ cart_count }}</div>
        </a>
    </div>

    <!-- Filters Card -->
    <div class="card bg-base-100 shadow-xl mb-6">
        <div class="card-body">
            <h2 class="card-title mb-4">Filter Customers</h2>
            <form method="get" action="">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="form-control">
                        <input type="text" 
                               id="search"
                               name="search" 
                               placeholder="Search by name, email, or company..." 
                               value="{{ search_query }}"
                               class="input input-bordered w-full">
                    </div>
                    
                    <div class="form-control">
                        <select name="city" id="city" class="select select-bordered w-full">
                            <option value="">All Cities</option>
                            {% for city in cities %}
                                <option value="{{ city }}" {% if city == city_filter %}selected{% endif %}>{{ city }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-control">
                        <select name="state" id="state" class="select select-bordered w-full">
                            <option value="">All States</option>
                            {% for state in states %}
                                <option value="{{ state }}" {% if state == state_filter %}selected{% endif %}>{{ state }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <button type="submit" class="btn btn-outline w-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                            </svg>
                            Apply Filters
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Selection Controls -->
    <div class="card bg-base-100 shadow-xl mb-6">
        <div class="card-body py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="btn-group">
                        <button onclick="selectAll()" class="btn btn-sm btn-ghost">Select All</button>
                        <button onclick="selectNone()" class="btn btn-sm btn-ghost">Select None</button>
                    </div>
                    <div class="divider divider-horizontal"></div>
                    <span id="selection-status" class="text-sm text-base-content/60"></span>
                </div>
                <button onclick="addSelected()" class="btn btn-success">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    Add Selected to Cart
                </button>
            </div>
        </div>
    </div>

    <!-- Customer Table -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body p-0">
            <div class="overflow-x-auto">
                <table class="table">
                    <thead>
                        <tr>
                            <th>
                                <label>
                                    <input type="checkbox" id="select-all-checkbox" onchange="toggleAll(this)" class="checkbox checkbox-primary" />
                                </label>
                            </th>
                            <th>Name</th>
                            <th>Company</th>
                            <th>Email</th>
                            <th>City</th>
                            <th>State</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for customer in customers %}
                        <tr class="hover">
                            <th>
                                <label>
                                    <input type="checkbox" 
                                           class="customer-checkbox checkbox checkbox-primary" 
                                           value="{{ customer.id }}"
                                           {% if customer.id in cart_customer_ids %}disabled{% endif %} />
                                </label>
                            </th>
                            <td>
                                <div class="flex items-center gap-3">
                                    <div class="avatar placeholder">
                                        <div class="bg-primary text-primary-content rounded-full w-10">
                                            <span class="text-sm">{{ customer.first_name.0|upper }}{{ customer.last_name.0|upper }}</span>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="font-bold">{{ customer.get_full_name }}</div>
                                    </div>
                                </div>
                            </td>
                            <td>{{ customer.company_name|default:"—" }}</td>
                            <td>{{ customer.email }}</td>
                            <td>{{ customer.city|default:"—" }}</td>
                            <td>{{ customer.state|default:"—" }}</td>
                            <td>
                                {% if customer.id in cart_customer_ids %}
                                    <div class="badge badge-success gap-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                        </svg>
                                        In Cart
                                    </div>
                                {% else %}
                                    <span class="text-base-content/40">—</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-12">
                                <div class="text-base-content/60">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                    </svg>
                                    <p class="text-lg font-medium">No customers found</p>
                                    <p class="text-sm mt-1">Try adjusting your filters to see more results</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{% csrf_token %}

<!-- Success Toast -->
<div id="success-toast" class="toast toast-top toast-end hidden">
    <div class="alert alert-success">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span id="toast-message">Success!</span>
    </div>
</div>

<script>
function toggleAll(checkbox) {
    // Get all checkboxes and filter manually
    const allCheckboxes = document.querySelectorAll('.customer-checkbox');
    allCheckboxes.forEach(cb => {
        if (!cb.disabled && !cb.hasAttribute('disabled')) {
            cb.checked = checkbox.checked;
        }
    });
}

function selectAll() {
    // Get all checkboxes
    const allCheckboxes = document.querySelectorAll('.customer-checkbox');
    const enabledCheckboxes = [];
    
    // Filter out disabled checkboxes manually
    allCheckboxes.forEach(cb => {
        if (!cb.disabled && !cb.hasAttribute('disabled')) {
            enabledCheckboxes.push(cb);
        }
    });
    
    if (enabledCheckboxes.length === 0) {
        // No need for alert - status message shows this
        return;
    }
    
    // Check all enabled checkboxes
    enabledCheckboxes.forEach(cb => {
        cb.checked = true;
    });
    
    // Update the select-all checkbox
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = true;
    }
    
    // Update status
    updateSelectionStatus();
}

function selectNone() {
    // Uncheck all checkboxes (including disabled ones)
    const checkboxes = document.querySelectorAll('.customer-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = false;
    });
    
    // Update the select-all checkbox
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = false;
    }
    
    // Update status
    updateSelectionStatus();
}

function addSelected() {
    const selected = [];
    document.querySelectorAll('.customer-checkbox:checked').forEach(cb => {
        selected.push(cb.value);
    });
    
    if (selected.length === 0) {
        alert('Please select at least one customer');
        return;
    }
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch("{% url 'email_campaign:add_to_cart' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'customer_ids[]=' + selected.join('&customer_ids[]=')
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('cart-count').textContent = data.total_count;
            // Disable added checkboxes
            selected.forEach(id => {
                const checkbox = document.querySelector(`input[value="${id}"]`);
                checkbox.disabled = true;
                checkbox.checked = false;
                const row = checkbox.closest('tr');
                const statusCell = row.querySelector('td:last-child');
                statusCell.innerHTML = '<div class="badge badge-success gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>In Cart</div>';
            });
            
            // Show success message
            const toast = document.getElementById('success-toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = `Added ${data.added_count} customer${data.added_count > 1 ? 's' : ''} to cart`;
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }
    });
}
// Update selection status
function updateSelectionStatus() {
    const allCheckboxes = document.querySelectorAll('.customer-checkbox');
    const enabledCheckboxes = document.querySelectorAll('.customer-checkbox:not([disabled])');
    const checkedCheckboxes = document.querySelectorAll('.customer-checkbox:checked');
    
    const statusElement = document.getElementById('selection-status');
    if (statusElement) {
        if (enabledCheckboxes.length === 0) {
            statusElement.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>All customers on this page are already in cart';
        } else {
            statusElement.textContent = `${checkedCheckboxes.length} of ${enabledCheckboxes.length} available selected`;
        }
    }
}

// Ensure DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    updateSelectionStatus();
    
    // Add change listeners to all checkboxes
    document.querySelectorAll('.customer-checkbox').forEach(cb => {
        cb.addEventListener('change', updateSelectionStatus);
    });
});
</script>
{% endblock %}