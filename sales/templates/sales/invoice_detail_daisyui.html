{% extends 'dashboard/base_daisyui.html' %}

{% block title %}Invoice {{ invoice.invoice_number }}{% endblock %}

{% block dashboard_content %}
<div class="space-y-6">
    <!-- Breadcrumb -->
    <div class="text-sm breadcrumbs">
        <ul>
            <li><a href="{% url 'dashboard:home' %}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
            </a></li>
            <li><a href="{% url 'sales:invoice_list' %}">Invoices</a></li>
            <li>{{ invoice.invoice_number }}</li>
        </ul>
    </div>

    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div class="flex items-center gap-3">
            <h1 class="text-3xl font-bold">Invoice {{ invoice.invoice_number }}</h1>
            {% if invoice.status == 'draft' %}
                <div class="badge badge-ghost">Draft</div>
            {% elif invoice.status == 'sent' %}
                <div class="badge badge-info">Sent</div>
            {% elif invoice.status == 'viewed' %}
                <div class="badge badge-secondary">Viewed</div>
            {% elif invoice.status == 'paid' %}
                <div class="badge badge-success">Paid</div>
            {% elif invoice.status == 'overdue' %}
                <div class="badge badge-error">Overdue</div>
            {% elif invoice.status == 'cancelled' %}
                <div class="badge badge-ghost">Cancelled</div>
            {% elif invoice.status == 'refunded' %}
                <div class="badge badge-warning">Refunded</div>
            {% endif %}
            
            {% if invoice.payment_status == 'unpaid' %}
                <div class="badge badge-error">Unpaid</div>
            {% elif invoice.payment_status == 'partial' %}
                <div class="badge badge-warning">Partial</div>
            {% elif invoice.payment_status == 'paid' %}
                <div class="badge badge-success">Paid</div>
            {% elif invoice.payment_status == 'overdue' %}
                <div class="badge badge-error">Overdue</div>
            {% endif %}
        </div>
        <div class="flex flex-wrap gap-2">
            {% if invoice.status == 'draft' %}
            <button class="btn btn-info btn-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
                Send Invoice
            </button>
            {% endif %}
            {% if invoice.shipping_status != 'shipped' %}
            <form method="post" action="{% url 'sales:invoice_mark_shipped' invoice.pk %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-info btn-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0" />
                    </svg>
                    Mark as Shipped
                </button>
            </form>
            {% endif %}
            <form method="post" action="{% url 'sales:invoice_recalculate' invoice.pk %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline btn-warning btn-sm" title="Recalculate invoice totals, payments, and status">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Recalculate
                </button>
            </form>
            <button onclick="window.print()" class="btn btn-ghost btn-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                </svg>
                Print
            </button>
            <a href="{% url 'sales:invoice_update' invoice.pk %}" class="btn btn-primary btn-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                Edit
            </a>
            <button onclick="document.getElementById('delete_modal').showModal()" class="btn btn-error btn-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                Delete
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 space-y-6">
            <!-- Invoice Information -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Invoice Information
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div>
                            <div class="text-sm text-base-content/60">Customer</div>
                            <div class="font-medium">
                                {% if invoice.customer %}
                                    <a href="{% url 'customer:customer_detail' invoice.customer.pk %}" class="link link-primary">
                                        {{ invoice.customer.get_full_name }}
                                        {% if invoice.customer.company_name %}<br>{{ invoice.customer.company_name }}{% endif %}
                                    </a>
                                {% elif invoice.is_shop_order %}
                                    {{ invoice.first_name }} {{ invoice.last_name }}
                                    {% if invoice.email %}<br><small class="text-base-content/60">{{ invoice.email }}</small>{% endif %}
                                    {% if invoice.phone %}<br><small class="text-base-content/60">{{ invoice.phone }}</small>{% endif %}
                                {% else %}
                                    <span class="text-base-content/60">No customer assigned</span>
                                {% endif %}
                            </div>
                        </div>
                        <div>
                            <div class="text-sm text-base-content/60">Invoice Date</div>
                            <div class="font-medium">{{ invoice.invoice_date|date:"F d, Y" }}</div>
                        </div>
                        <div>
                            <div class="text-sm text-base-content/60">Due Date</div>
                            <div class="font-medium">{{ invoice.due_date|date:"F d, Y" }}</div>
                        </div>
                        {% if invoice.order %}
                        <div>
                            <div class="text-sm text-base-content/60">Related Order</div>
                            <div class="font-medium">
                                <a href="{% url 'sales:order_detail' invoice.order.pk %}" class="link link-primary">
                                    {{ invoice.order.order_number }}
                                </a>
                            </div>
                        </div>
                        {% endif %}
                        {% if invoice.sent_date %}
                        <div>
                            <div class="text-sm text-base-content/60">Sent Date</div>
                            <div class="font-medium">{{ invoice.sent_date|date:"F d, Y" }}</div>
                        </div>
                        {% endif %}
                        {% if invoice.viewed_date %}
                        <div>
                            <div class="text-sm text-base-content/60">First Viewed</div>
                            <div class="font-medium">{{ invoice.viewed_date|date:"F d, Y" }}</div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Billing Address -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        Billing Address
                    </h2>
                    <address class="not-italic mt-4">
                        {{ invoice.billing_address_line1 }}<br>
                        {% if invoice.billing_address_line2 %}{{ invoice.billing_address_line2 }}<br>{% endif %}
                        {{ invoice.billing_city }}, {{ invoice.billing_state }} {{ invoice.billing_postal_code }}<br>
                        {{ invoice.billing_country }}
                    </address>
                </div>
            </div>


            <!-- Line Items -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <div class="flex items-center justify-between">
                        <h2 class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                            </svg>
                            Invoice Items
                        </h2>
                        {% if invoice.status == 'draft' %}
                        <a href="{% url 'sales:invoice_item_add' invoice.pk %}" class="btn btn-ghost btn-xs">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            Add Item
                        </a>
                        {% endif %}
                    </div>
                    <div class="overflow-x-auto mt-4">
                        <table class="table table-zebra">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th class="text-right">Quantity</th>
                                    <th class="text-right">Unit Price</th>
                                    <th class="text-right">Discount</th>
                                    <th class="text-right">Line Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in items %}
                                <tr>
                                    <td>
                                        <div class="font-medium">{{ item.description }}</div>
                                        {% if item.product %}
                                        <div class="text-xs text-base-content/60">{{ item.product.name }}</div>
                                            {% if item.product.supplier %}
                                            <div class="text-xs text-base-content/50">
                                                Supplier: <a href="{% url 'purchases:supplier_detail' item.product.supplier.pk %}" class="link link-primary">{{ item.product.supplier.name }}</a>
                                            </div>
                                            {% endif %}
                                        {% endif %}
                                        {% if item.product_options %}
                                        <div class="text-xs text-info">
                                            {% for key, value in item.product_options.items %}
                                                {{ key }}: {{ value }}{% if not forloop.last %}, {% endif %}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                        {% if item.inventory %}
                                        <div class="text-xs text-primary">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                                            </svg>
                                            SN: {{ item.inventory.serial_number }}
                                        </div>
                                        {% endif %}
                                    </td>
                                    <td class="text-right">{{ item.quantity|floatformat:"-2" }}</td>
                                    <td class="text-right">${{ item.unit_price|floatformat:2 }}</td>
                                    <td class="text-right">{{ item.discount_percent|floatformat:"-2" }}%</td>
                                    <td class="text-right font-semibold">${{ item.line_total|floatformat:2 }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center py-8">
                                        <div class="text-base-content/60">No items added yet</div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Payment History -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <div class="flex items-center justify-between">
                        <h2 class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                            Payment History
                        </h2>
                        <a href="{% url 'sales:payment_add' invoice_pk=invoice.pk %}" class="btn btn-primary btn-xs">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            Record Payment
                        </a>
                    </div>
                    {% if payments %}
                    <div class="space-y-3 mt-4">
                        {% for payment in payments %}
                        <div class="border-l-4 {% if payment.status == 'completed' %}border-success{% elif payment.status == 'pending' %}border-warning{% else %}border-base-300{% endif %} pl-4 py-2">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <div class="font-semibold">${{ payment.amount|floatformat:2 }}</div>
                                        {% if payment.payment_number %}
                                        <div class="badge badge-primary badge-sm">{{ payment.payment_number }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="text-sm text-base-content/60">{{ payment.payment_date|date:"F d, Y" }}</div>
                                    <div class="text-xs text-base-content/50 mt-1">
                                        Method: {{ payment.get_payment_method_display }}
                                        {% if payment.reference_number %}
                                        <br>Ref: {{ payment.reference_number }}
                                        {% endif %}
                                        {% if payment.notes %}
                                        <br>Note: {{ payment.notes|truncatechars:50 }}
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="flex items-start gap-2">
                                    {% if payment.status == 'completed' %}
                                        <div class="badge badge-success badge-sm">Completed</div>
                                    {% elif payment.status == 'pending' %}
                                        <div class="badge badge-warning badge-sm">Pending</div>
                                    {% elif payment.status == 'processing' %}
                                        <div class="badge badge-info badge-sm">Processing</div>
                                    {% elif payment.status == 'failed' %}
                                        <div class="badge badge-error badge-sm">Failed</div>
                                    {% elif payment.status == 'refunded' %}
                                        <div class="badge badge-secondary badge-sm">Refunded</div>
                                    {% else %}
                                        <div class="badge badge-ghost badge-sm">{{ payment.get_status_display }}</div>
                                    {% endif %}
                                    
                                    <!-- Dropdown menu for payment actions -->
                                    <div class="dropdown dropdown-end">
                                        <label tabindex="0" class="btn btn-ghost btn-xs">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                                            </svg>
                                        </label>
                                        <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52 z-50">
                                            <li>
                                                <a href="{% url 'sales:payment_detail' pk=payment.pk %}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                                    </svg>
                                                    View Details
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-8">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-base-content/20 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                        <p class="text-base-content/60">No payments recorded yet</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            {% if invoice.notes %}
            <!-- Notes -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H7a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        Notes
                    </h2>
                    <div class="whitespace-pre-wrap mt-4">{{ invoice.notes }}</div>
                </div>
            </div>
            {% endif %}

            {% if invoice.internal_notes %}
            <!-- Internal Notes -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                        Internal Notes
                    </h2>
                    <div class="whitespace-pre-wrap mt-4">{{ invoice.internal_notes }}</div>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="space-y-6">
            <!-- Invoice Summary -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                        </svg>
                        Invoice Summary
                    </h2>
                    <div class="space-y-3 mt-4">
                        <div class="flex justify-between text-sm">
                            <span class="text-base-content/60">Subtotal</span>
                            <span>${{ invoice.subtotal|floatformat:2 }}</span>
                        </div>
                        {% if invoice.discount_amount > 0 %}
                        <div class="flex justify-between text-sm">
                            <span class="text-base-content/60">Discount ({{ invoice.discount_percent|floatformat:"-2" }}%)</span>
                            <span class="text-error">-${{ invoice.discount_amount|floatformat:2 }}</span>
                        </div>
                        {% endif %}
                        {% if invoice.tax_amount > 0 %}
                        <div class="flex justify-between text-sm">
                            <span class="text-base-content/60">Tax ({{ invoice.tax_rate|floatformat:"-2" }}%)</span>
                            <span>${{ invoice.tax_amount|floatformat:2 }}</span>
                        </div>
                        {% endif %}
                        {% if invoice.shipping_cost > 0 %}
                        <div class="flex justify-between text-sm">
                            <span class="text-base-content/60">Shipping</span>
                            <span>${{ invoice.shipping_cost|floatformat:2 }}</span>
                        </div>
                        {% endif %}
                        <div class="divider"></div>
                        <div class="flex justify-between">
                            <span class="font-semibold">Total</span>
                            <span class="text-xl font-bold">${{ invoice.total_amount|floatformat:2 }}</span>
                        </div>
                        {% if invoice.paid_amount > 0 %}
                        <div class="divider"></div>
                        <div class="flex justify-between text-sm">
                            <span class="text-base-content/60">Paid Amount</span>
                            <span class="text-success">${{ invoice.paid_amount|floatformat:2 }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-semibold">Balance Due</span>
                            <span class="text-lg font-bold {% if invoice.balance_due > 0 %}text-error{% endif %}">${{ invoice.balance_due|floatformat:2 }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Shipping Information -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <div class="flex items-center justify-between">
                        <h2 class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                            </svg>
                            Shipping 
                        </h2>
                        <a href="{% url 'sales:shipment_add' invoice.pk %}" class="btn btn-primary btn-xs">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            Create Shipment
                        </a>
                    </div>
                    {% if shipments %}
                    <div class="space-y-3 mt-4">
                        {% for shipment in shipments %}
                        <div class="border-l-4 {% if shipment.status == 'delivered' %}border-success{% elif shipment.status in 'shipped,in_transit,out_for_delivery' %}border-info{% elif shipment.status == 'cancelled' %}border-error{% else %}border-base-300{% endif %} pl-4 py-2">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                    <div class="font-semibold">{{ shipment.shipment_number }}</div>
                                    {% if shipment.status == 'pending' %}
                                    <div class="badge badge-ghost badge-sm">Pending</div>
                                    {% elif shipment.status == 'processing' %}
                                        <div class="badge badge-warning badge-sm">Processing</div>
                                    {% elif shipment.status == 'ready' %}
                                        <div class="badge badge-info badge-sm">Ready</div>
                                    {% elif shipment.status == 'shipped' %}
                                        <div class="badge badge-info badge-sm">Shipped</div>
                                    {% elif shipment.status == 'in_transit' %}
                                        <div class="badge badge-info badge-sm">In Transit</div>
                                    {% elif shipment.status == 'out_for_delivery' %}
                                        <div class="badge badge-primary badge-sm">Out for Delivery</div>
                                    {% elif shipment.status == 'delivered' %}
                                        <div class="badge badge-success badge-sm">Delivered</div>
                                    {% elif shipment.status == 'failed_delivery' %}
                                        <div class="badge badge-warning badge-sm">Failed Delivery</div>
                                    {% elif shipment.status == 'returned' %}
                                        <div class="badge badge-error badge-sm">Returned</div>
                                    {% elif shipment.status == 'cancelled' %}
                                        <div class="badge badge-error badge-sm">Cancelled</div>
                                    {% else %}
                                        <div class="badge badge-ghost badge-sm">{{ shipment.get_status_display }}</div>
                                    {% endif %}
                                    </div>
                                    
                                    {% if shipment.supplier %}
                                    <div class="text-sm text-base-content/60 mb-1">
                                        Supplier: <a href="{% url 'purchases:supplier_detail' shipment.supplier.pk %}" class="link link-primary">{{ shipment.supplier.name }}</a>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Shipping Address -->
                                    {% if shipment.ship_to_name %}
                                    <div class="text-sm text-base-content/60 mb-2">
                                        <div class="font-medium">Ship To:</div>
                                        <div class="text-xs text-base-content/50 ml-2">
                                            {{ shipment.ship_to_name }}{% if shipment.ship_to_company %} ({{ shipment.ship_to_company }}){% endif %}<br>
                                            {{ shipment.ship_to_address_line1 }}{% if shipment.ship_to_address_line2 %}, {{ shipment.ship_to_address_line2 }}{% endif %}<br>
                                            {{ shipment.ship_to_city }}, {{ shipment.ship_to_state }} {{ shipment.ship_to_postal_code }}<br>
                                            {{ shipment.ship_to_country }}
                                            {% if shipment.ship_to_phone %}<br>📞 {{ shipment.ship_to_phone }}{% endif %}
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    {% if shipment.tracking_number %}
                                    <div class="text-sm text-base-content/50 mb-1">
                                        <span class="font-semibold">{{ shipment.get_carrier_display }}:</span> 
                                        <span class="font-mono">{{ shipment.tracking_number }}</span>
                                        {% if shipment.get_tracking_url %}
                                        <a href="{{ shipment.get_tracking_url }}" target="_blank" class="link link-primary ml-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                            </svg>
                                            Track
                                        </a>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    {% if shipment.ship_date %}
                                    <div class="text-xs text-base-content/50">
                                        Shipped: {{ shipment.ship_date|date:"M d, Y" }}
                                    </div>
                                    {% endif %}
                                    {% if shipment.estimated_delivery %}
                                    <div class="text-xs text-base-content/50">
                                        Est. Delivery: {{ shipment.estimated_delivery|date:"M d, Y" }}
                                    </div>
                                    {% endif %}
                                    {% if shipment.actual_delivery %}
                                    <div class="text-xs text-success">
                                        Delivered: {{ shipment.actual_delivery|date:"M d, Y" }}
                                        {% if shipment.delivered_to %}to {{ shipment.delivered_to }}{% endif %}
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Shipment Items -->
                                    {% if shipment.items.all %}
                                    <div class="mt-2">
                                        <div class="text-xs font-semibold text-base-content/70">Items in this shipment:</div>
                                        <ul class="text-xs text-base-content/50 ml-2">
                                            {% for item in shipment.items.all %}
                                            <li>• {{ item.invoice_item.description }} (Qty: {{ item.quantity_shipped|floatformat:"-2" }})</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="text-right flex flex-col w-20">
                                    <div class="dropdown dropdown-end">
                                        <div tabindex="0" role="button" class="btn btn-ghost btn-xs">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                                            </svg>
                                        </div>
                                        <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-48 z-10">
                                            <li>
                                                <a href="{% url 'sales:shipment_detail' shipment.pk %}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                                    </svg>
                                                    View Details
                                                </a>
                                            </li>
                                            <li>
                                                <a href="{% url 'sales:shipment_update' shipment.pk %}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                    </svg>
                                                    Edit Shipment
                                                </a>
                                            </li>
                                            <div class="divider my-1"></div>
                                            <li>
                                                <a href="#" onclick="confirmDeleteShipment('{{ shipment.pk }}', '{{ shipment.shipment_number }}'); return false;" class="text-error">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1-1H8a1 1 0 00-1 1v3M4 7h16" />
                                                    </svg>
                                                    Delete Shipment
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                    
                                    {% if shipment.package_count > 1 %}
                                    <div class="text-xs text-base-content/50 mt-1">
                                        {{ shipment.package_count }} packages
                                    </div>
                                    {% endif %}
                                    
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-8">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-base-content/20 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                        </svg>
                        <p class="text-base-content/60">No shipments created yet</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Credit Notes -->
            {% if invoice.credit_notes.exists %}
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2zM10 8.5a.5.5 0 11-1 0 .5.5 0 011 0zm5 5a.5.5 0 11-1 0 .5.5 0 011 0z" />
                        </svg>
                        Credit Notes
                    </h2>
                    <div class="space-y-2 mt-4">
                        {% for credit_note in invoice.credit_notes.all %}
                        <a href="{% url 'sales:credit_note_detail' credit_note.pk %}" class="link link-primary text-sm">
                            {{ credit_note.credit_note_number }} - ${{ credit_note.total_amount|floatformat:2 }}
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Delete Invoice Modal -->
<dialog id="delete_modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Delete Invoice</h3>
        <p class="py-4">Are you sure you want to delete invoice <strong>{{ invoice.invoice_number }}</strong>? This will also delete all associated line items and payment records.</p>
        <div class="modal-action">
            <form method="dialog">
                <button class="btn">Cancel</button>
            </form>
            <form method="POST" action="{% url 'sales:invoice_delete' invoice.pk %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-error">Delete Invoice</button>
            </form>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Delete Shipment Modal -->
<dialog id="delete_shipment_modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Delete Shipment</h3>
        <p class="py-4">Are you sure you want to delete shipment <strong id="shipment-number-display"></strong>? This action cannot be undone.</p>
        <div class="modal-action">
            <form method="dialog">
                <button class="btn">Cancel</button>
            </form>
            <form id="delete-shipment-form" method="POST" action="">
                {% csrf_token %}
                <button type="submit" class="btn btn-error">Delete Shipment</button>
            </form>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
function confirmDeleteShipment(shipmentId, shipmentNumber) {
    // Update the modal content
    document.getElementById('shipment-number-display').textContent = shipmentNumber;
    
    // Update the form action URL
    const deleteForm = document.getElementById('delete-shipment-form');
    deleteForm.action = `/home/sales/shipments/${shipmentId}/delete/`;
    
    // Show the modal
    document.getElementById('delete_shipment_modal').showModal();
}
</script>

{% endblock %}