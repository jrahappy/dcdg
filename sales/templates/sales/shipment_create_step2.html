{% extends 'dashboard/base_daisyui.html' %}

{% block title %}Create Shipment - Step 2{% endblock %}

{% block dashboard_content %}
<div class="space-y-6">
    <!-- Breadcrumb -->
    <div class="text-sm breadcrumbs">
        <ul>
            <li><a href="{% url 'dashboard:home' %}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
            </a></li>
            <li><a href="{% url 'sales:invoice_list' %}">Invoices</a></li>
            <li><a href="{% url 'sales:invoice_detail' invoice.pk %}">Invoice #{{ invoice.invoice_number }}</a></li>
            <li>Create Shipment - Step 2</li>
        </ul>
    </div>

    <!-- Header with Progress Steps -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                <h1 class="text-2xl font-bold">Create Shipment for Invoice #{{ invoice.invoice_number }}</h1>
                
                <!-- Progress Steps -->
                <ul class="steps">
                    <li class="step step-primary">Shipment Details</li>
                    <li class="step step-primary">Select Items</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Shipment Summary -->
    <div class="card bg-base-200">
        <div class="card-body">
            <h3 class="font-semibold mb-2">Shipment Details</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                {% if shipment_data.carrier %}
                <div>
                    <span class="text-base-content/60">Carrier:</span>
                    <span class="font-medium ml-2">{{ shipment_data.carrier }}</span>
                </div>
                {% endif %}
                {% if shipment_data.tracking_number %}
                <div>
                    <span class="text-base-content/60">Tracking:</span>
                    <span class="font-medium ml-2">{{ shipment_data.tracking_number }}</span>
                </div>
                {% endif %}
                {% if shipment_data.service_type %}
                <div>
                    <span class="text-base-content/60">Service:</span>
                    <span class="font-medium ml-2">{{ shipment_data.service_type }}</span>
                </div>
                {% endif %}
                {% if shipment_data.status %}
                <div>
                    <span class="text-base-content/60">Status:</span>
                    <span class="font-medium ml-2">{{ shipment_data.status }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Items Selection -->
    <form method="post" id="shipmentItemsForm">
        {% csrf_token %}
        
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title mb-4">Select Items to Ship</h2>
                
                {% if invoice_items %}
                <div class="alert alert-info mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>Select the items and quantities you want to include in this shipment. You can create multiple shipments for partial deliveries.</span>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="table table-zebra">
                        <thead>
                            <tr>
                                <th>
                                    <label>
                                        <input type="checkbox" id="selectAll" class="checkbox checkbox-primary" />
                                    </label>
                                </th>
                                <th>Product</th>
                                <th>Description</th>
                                <th class="text-right">Ordered</th>
                                <th class="text-right">Already Shipped</th>
                                <th class="text-right">Remaining</th>
                                <th class="text-right">Quantity to Ship</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in invoice_items %}
                            <tr>
                                <th>
                                    <label>
                                        <input type="checkbox" 
                                               name="selected_items" 
                                               value="{{ item.id }}" 
                                               class="checkbox checkbox-primary item-checkbox"
                                               data-item-id="{{ item.id }}"
                                               data-remaining="{{ item.remaining_quantity }}" />
                                    </label>
                                </th>
                                <td>
                                    {% if item.product %}
                                        <div class="font-medium">{{ item.product.name }}</div>
                                        <div class="text-sm text-base-content/60">SKU: {{ item.product.sku }}</div>
                                    {% else %}
                                        <span class="text-base-content/60">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ item.description }}
                                    {% if item.product_options %}
                                        <div class="text-sm text-base-content/60">
                                            {% for key, value in item.product_options.items %}
                                                {{ key }}: {{ value }}{% if not forloop.last %}, {% endif %}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </td>
                                <td class="text-right">{{ item.quantity|floatformat:0 }}</td>
                                <td class="text-right">
                                    {% if item.shipped_quantity > 0 %}
                                        <span class="badge badge-info">{{ item.shipped_quantity|floatformat:0 }}</span>
                                    {% else %}
                                        0
                                    {% endif %}
                                </td>
                                <td class="text-right">
                                    <span class="font-semibold {% if item.remaining_quantity == 0 %}text-success{% endif %}">
                                        {{ item.remaining_quantity|floatformat:0 }}
                                    </span>
                                </td>
                                <td class="text-right">
                                    <input type="number" 
                                           name="quantity_{{ item.id }}" 
                                           id="quantity_{{ item.id }}"
                                           min="0" 
                                           max="{{ item.remaining_quantity }}" 
                                           value="{{ item.remaining_quantity }}"
                                           class="input input-bordered input-sm w-24 text-right quantity-input"
                                           disabled />
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>All items from this invoice have already been shipped.</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-between">
            <a href="{% url 'sales:shipment_create_step1' invoice_pk=invoice.pk %}" class="btn btn-ghost">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Back
            </a>
            
            {% if invoice_items %}
            <button type="submit" class="btn btn-primary" id="createShipmentBtn">
                Create Shipment
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
            </button>
            {% else %}
            <a href="{% url 'sales:invoice_detail' invoice.pk %}" class="btn btn-primary">
                Back to Invoice
            </a>
            {% endif %}
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Select all checkbox
    const selectAllCheckbox = document.getElementById('selectAll');
    const itemCheckboxes = document.querySelectorAll('.item-checkbox');
    const quantityInputs = document.querySelectorAll('.quantity-input');
    
    // Handle select all
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            itemCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
                const itemId = checkbox.dataset.itemId;
                const quantityInput = document.getElementById('quantity_' + itemId);
                if (quantityInput) {
                    quantityInput.disabled = !this.checked;
                    if (!this.checked) {
                        quantityInput.value = 0;
                    } else {
                        quantityInput.value = checkbox.dataset.remaining;
                    }
                }
            });
        });
    }
    
    // Handle individual checkbox changes
    itemCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const itemId = this.dataset.itemId;
            const quantityInput = document.getElementById('quantity_' + itemId);
            if (quantityInput) {
                quantityInput.disabled = !this.checked;
                if (!this.checked) {
                    quantityInput.value = 0;
                } else {
                    quantityInput.value = this.dataset.remaining;
                }
            }
            
            // Update select all checkbox
            const allChecked = Array.from(itemCheckboxes).every(cb => cb.checked);
            const someChecked = Array.from(itemCheckboxes).some(cb => cb.checked);
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = allChecked;
                selectAllCheckbox.indeterminate = someChecked && !allChecked;
            }
        });
    });
    
    // Form validation
    const form = document.getElementById('shipmentItemsForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            const checkedItems = document.querySelectorAll('.item-checkbox:checked');
            if (checkedItems.length === 0) {
                e.preventDefault();
                alert('Please select at least one item to ship.');
                return false;
            }
            
            // Validate quantities
            let hasValidQuantity = false;
            checkedItems.forEach(checkbox => {
                const itemId = checkbox.dataset.itemId;
                const quantityInput = document.getElementById('quantity_' + itemId);
                if (quantityInput && parseFloat(quantityInput.value) > 0) {
                    hasValidQuantity = true;
                }
            });
            
            if (!hasValidQuantity) {
                e.preventDefault();
                alert('Please enter a valid quantity for at least one selected item.');
                return false;
            }
        });
    }
});
</script>

{% endblock %}