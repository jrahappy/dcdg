{% extends 'dashboard/base_daisyui.html' %}

{% block title %}Purchase Order {{ order.order_number }}{% endblock %}

{% block dashboard_content %}
<div class="space-y-6">
    <!-- Breadcrumb -->
    <div class="text-sm breadcrumbs">
        <ul>
            <li><a href="{% url 'dashboard:home' %}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
            </a></li>
            <li><a href="{% url 'purchases:purchase_order_list' %}">Purchase Orders</a></li>
            <li>{{ order.order_number }}</li>
        </ul>
    </div>

    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div class="flex items-center gap-3">
            <h1 class="text-3xl font-bold">Purchase Order {{ order.order_number }}</h1>
            {% if order.status == 'draft' %}
                <div class="badge badge-ghost">Draft</div>
            {% elif order.status == 'sent' %}
                <div class="badge badge-info">Sent</div>
            {% elif order.status == 'confirmed' %}
                <div class="badge badge-secondary">Confirmed</div>
            {% elif order.status == 'partially_received' %}
                <div class="badge badge-warning">Partially Received</div>
            {% elif order.status == 'received' %}
                <div class="badge badge-success">Received</div>
            {% elif order.status == 'cancelled' %}
                <div class="badge badge-error">Cancelled</div>
            {% endif %}
        </div>
        <div class="flex flex-wrap gap-2">
            {% if order.status == 'draft' %}
            <button class="btn btn-info btn-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
                Send Order
            </button>
            {% endif %}
            {% if order.status in 'confirmed,partially_received' %}
            <a href="{% url 'purchases:purchase_order_receive' order.pk %}" class="btn btn-success btn-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                </svg>
                Receive Items
            </a>
            {% endif %}
            <a href="{% url 'purchases:supplier_payment_create' order.pk %}" class="btn btn-warning btn-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                Record Payment
            </a>
            <button onclick="window.print()" class="btn btn-ghost btn-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                </svg>
                Print
            </button>
            <a href="{% url 'purchases:purchase_order_edit_step1' order.pk %}" class="btn btn-primary btn-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                Edit
            </a>
            <button onclick="document.getElementById('delete_modal').showModal()" class="btn btn-error btn-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                Delete
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 space-y-6">
            <!-- Order Information -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Order Information
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div>
                            <div class="text-sm text-base-content/60">Supplier</div>
                            <div class="font-medium">
                                {% if order.supplier %}
                                    <a href="{% url 'purchases:supplier_detail' order.supplier.pk %}" class="link link-primary">
                                        {{ order.supplier.name }}
                                    </a>
                                    {% if order.supplier.contact_person %}<br>{{ order.supplier.contact_person }}{% endif %}
                                    {% if order.supplier.email %}<br><small class="text-base-content/60">{{ order.supplier.email }}</small>{% endif %}
                                {% else %}
                                    <span class="text-base-content/60">No supplier assigned</span>
                                {% endif %}
                            </div>
                        </div>
                        <div>
                            <div class="text-sm text-base-content/60">Order Date</div>
                            <div class="font-medium">{{ order.order_date|date:"F d, Y" }}</div>
                        </div>
                        <div>
                            <div class="text-sm text-base-content/60">Expected Delivery</div>
                            <div class="font-medium">
                                {% if order.expected_delivery_date %}
                                    {{ order.expected_delivery_date|date:"F d, Y" }}
                                {% else %}
                                    <span class="text-base-content/60">Not specified</span>
                                {% endif %}
                            </div>
                        </div>
                        {% if order.reference_number %}
                        <div>
                            <div class="text-sm text-base-content/60">Reference Number</div>
                            <div class="font-medium">{{ order.reference_number }}</div>
                        </div>
                        {% endif %}
                        {% if order.received_date %}
                        <div>
                            <div class="text-sm text-base-content/60">Received Date</div>
                            <div class="font-medium">{{ order.received_date|date:"F d, Y" }}</div>
                        </div>
                        {% endif %}
                        <div>
                            <div class="text-sm text-base-content/60">Created By</div>
                            <div class="font-medium">
                                {% if order.created_by %}
                                    {{ order.created_by.get_full_name }}
                                {% else %}
                                    System
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Supplier Address -->
            {% if order.supplier %}
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        Supplier Address
                    </h2>
                    <address class="not-italic mt-4">
                        {{ order.supplier.address_line1 }}<br>
                        {% if order.supplier.address_line2 %}{{ order.supplier.address_line2 }}<br>{% endif %}
                        {{ order.supplier.city }}, {{ order.supplier.state }} {{ order.supplier.postal_code }}<br>
                        {{ order.supplier.get_country_display }}
                    </address>
                </div>
            </div>
            {% endif %}

            <!-- Order Items -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <h2 class="card-title">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                                </svg>
                                Order Items
                            </h2>
                            {% if order.order_number %}
                            <button hx-get="{% url 'purchases:purchase_order_inventory_list' order.pk %}"
                                    hx-target="#inventoryListContainer"
                                    hx-trigger="click"
                                    hx-swap="innerHTML"
                                    class="btn btn-ghost btn-xs">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                                </svg>
                                View All Inventory
                            </button>
                            {% endif %}
                        </div>
                        {% if total_pending_inventory > 0 %}
                        <div class="badge badge-error">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            {{ total_pending_inventory }} inventory items pending
                        </div>
                        {% endif %}
                    </div>
                    <div class="overflow-x-auto mt-4">
                        <table class="table table-zebra">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Description</th>
                                    <th class="text-right">Quantity</th>
                                    <th class="text-right">Unit Cost</th>
                                    <th class="text-right">Discount</th>
                                    <th class="text-right">Line Total</th>
                                    <th class="text-center">Received</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in order.items.all %}
                                <tr>
                                    <td>
                                        <a href="{% url 'product:product_detail' item.product.pk %}" class="link link-primary font-medium">
                                            {{ item.product.name }}
                                        </a>
                                        {% if item.product.is_serial_number_managed %}
                                        <div class="text-xs text-success">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                                            </svg>
                                            Serial Managed
                                        </div>
                                        {% endif %}
                                    </td>
                                    <td>{{ item.description }}</td>
                                    <td class="text-right">{{ item.quantity|floatformat:"-2" }}</td>
                                    <td class="text-right">${{ item.unit_cost|floatformat:2 }}</td>
                                    <td class="text-right">
                                        {% if item.discount_percent > 0 %}
                                            {{ item.discount_percent }}%
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td class="text-right font-semibold">${{ item.line_total|floatformat:2 }}</td>
                                    <td class="text-center">
                                        <div class="flex items-center justify-center gap-1">
                                            <span>{{ item.quantity_received|floatformat:"-2" }} / {{ item.quantity|floatformat:"-2" }}</span>
                                            {% if item.is_fully_received %}
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                            </svg>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        {% if item.product.is_serial_number_managed %}
                                        <div>
                                            <button onclick="openInventoryModal({{ item.id }}, '{{ item.product.name }}', {{ item.quantity|floatformat:0 }}, {{ item.inventory_created|default:0 }})"
                                                    class="btn btn-primary btn-xs">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                                                </svg>
                                                Register inventory
                                            </button>
                                            <div class="mt-1">
                                                <div class="text-xs text-base-content/60">
                                                    {{ item.inventory_created|default:0 }} / {{ item.quantity|floatformat:0 }} created
                                                    {% if item.inventory_created > 0 %}
                                                    <a href="{% url 'product:inventory_list' %}?purchase_order={{ order.order_number }}&product={{ item.product.id }}" 
                                                       class="link link-primary text-xs ml-1">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                                        </svg>
                                                        View
                                                    </a>
                                                    {% endif %}
                                                </div>
                                                {% if item.inventory_difference > 0 %}
                                                <div class="text-xs text-error font-medium">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                                    </svg>
                                                    {{ item.inventory_difference }} pending
                                                </div>
                                                {% elif item.inventory_difference == 0 %}
                                                <div class="text-xs text-success font-medium">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                    </svg>
                                                    Complete
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Inventory List Container -->
            <div id="inventoryListContainer">
                <!-- Inventory items will be loaded here via HTMX -->
            </div>

            {% if order.notes %}
            <!-- Notes -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H7a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        Notes
                    </h2>
                    <div class="whitespace-pre-wrap mt-4">{{ order.notes }}</div>
                </div>
            </div>
            {% endif %}

            <!-- Payment History -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <div class="flex items-center justify-between">
                        <h2 class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                            Payment History
                        </h2>
                        <a href="{% url 'purchases:supplier_payment_create' order.pk %}" class="btn btn-primary btn-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            Add Payment
                        </a>
                    </div>
                    
                    <!-- Payment Summary -->
                    <div class="bg-base-200 rounded-lg p-4 mt-4">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div>
                                <p class="text-sm font-semibold text-base-content/70">Order Total</p>
                                <p class="text-xl font-bold">${{ order.total_amount|floatformat:2 }}</p>
                            </div>
                            <div>
                                <p class="text-sm font-semibold text-base-content/70">Total Paid</p>
                                <p class="text-xl font-bold text-success">${{ total_paid|floatformat:2 }}</p>
                            </div>
                            <div>
                                <p class="text-sm font-semibold text-base-content/70">Balance Due</p>
                                <p class="text-xl font-bold {% if balance_due > 0 %}text-error{% else %}text-success{% endif %}">
                                    ${{ balance_due|floatformat:2 }}
                                </p>
                            </div>
                        </div>
                        {% if balance_due == 0 %}
                        <div class="mt-3">
                            <span class="badge badge-success badge-lg w-full">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Fully Paid
                            </span>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Payment List -->
                    {% if recent_payments %}
                    <div class="overflow-x-auto mt-4">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Method</th>
                                    <th>Status</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in recent_payments %}
                                <tr>
                                    <td>{{ payment.date|date:"M d, Y" }}</td>
                                    <td class="font-mono font-semibold">${{ payment.amount|floatformat:2 }}</td>
                                    <td>
                                        {% if payment.method %}
                                            <span class="badge badge-ghost badge-sm">{{ payment.get_method_display|default:payment.method|title }}</span>
                                        {% else %}
                                            <span class="text-base-content/50">--</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge {% if payment.status == 'APPROVED' %}badge-success{% else %}badge-warning{% endif %} badge-sm">
                                            {{ payment.get_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if payment.is_advance %}
                                            <span class="badge badge-info badge-sm">Advance</span>
                                        {% else %}
                                            <span class="badge badge-outline badge-sm">Regular</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-8">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-base-content/30 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        <p class="text-base-content/50">No payments recorded yet</p>
                        <a href="{% url 'purchases:supplier_payment_create' order.pk %}" class="btn btn-primary btn-sm mt-3">
                            Record First Payment
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            {% if order.internal_notes %}
            <!-- Internal Notes -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                        Internal Notes
                    </h2>
                    <div class="whitespace-pre-wrap mt-4">{{ order.internal_notes }}</div>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="space-y-6">
            <!-- Order Summary -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                        </svg>
                        Order Summary
                    </h2>
                    <div class="space-y-3 mt-4">
                        <div class="flex justify-between text-sm">
                            <span class="text-base-content/60">Subtotal</span>
                            <span>${{ order.subtotal|floatformat:2 }}</span>
                        </div>
                        {% if order.discount_amount > 0 %}
                        <div class="flex justify-between text-sm">
                            <span class="text-base-content/60">Discount ({{ order.discount_percent|floatformat:"-2" }}%)</span>
                            <span class="text-error">-${{ order.discount_amount|floatformat:2 }}</span>
                        </div>
                        {% endif %}
                        {% if order.tax_amount > 0 %}
                        <div class="flex justify-between text-sm">
                            <span class="text-base-content/60">Tax ({{ order.tax_rate|floatformat:"-2" }}%)</span>
                            <span>${{ order.tax_amount|floatformat:2 }}</span>
                        </div>
                        {% endif %}
                        {% if order.shipping_cost > 0 %}
                        <div class="flex justify-between text-sm">
                            <span class="text-base-content/60">Shipping</span>
                            <span>${{ order.shipping_cost|floatformat:2 }}</span>
                        </div>
                        {% endif %}
                        <div class="divider"></div>
                        <div class="flex justify-between">
                            <span class="font-semibold">Total</span>
                            <span class="text-xl font-bold">${{ order.total_amount|floatformat:2 }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Receiving History -->
            {% if order.receiving_history.exists %}
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                        </svg>
                        Receiving History
                    </h2>
                    <div class="space-y-3 mt-4">
                        {% for receipt in order.receiving_history.all %}
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-medium">{{ receipt.quantity_received }} items</div>
                                <div class="text-xs text-base-content/60">
                                    {{ receipt.received_date|date:"M d, Y" }} - {{ receipt.received_by.get_full_name }}
                                </div>
                            </div>
                            <div class="badge badge-success badge-sm">Received</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Delete Modal -->
<dialog id="delete_modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Delete Purchase Order</h3>
        <p class="py-4">Are you sure you want to delete order <strong>{{ order.order_number }}</strong>? This will also delete all associated line items and receiving records.</p>
        <div class="modal-action">
            <form method="dialog">
                <button class="btn">Cancel</button>
            </form>
            <form method="POST" action="{% url 'purchases:purchase_order_delete' order.pk %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-error">Delete Order</button>
            </form>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Inventory Creation Modal -->
<dialog id="inventory_modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Create Inventory Items</h3>
        <p class="text-sm text-base-content/60" id="modalProductName"></p>
        
        <div class="alert alert-info mt-4">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span class="text-sm">Enter serial numbers separated by commas. Each serial number will create one inventory item.</span>
        </div>
        
        <div class="form-control mt-4">
            <label class="label">
                <span class="label-text">Serial Numbers</span>
            </label>
            <textarea id="serialNumbers" rows="5" 
                      placeholder="SN001, SN002, SN003, ..."
                      class="textarea textarea-bordered"></textarea>
            <label class="label">
                <span class="label-text-alt">
                    Ordered quantity: <span id="receivedCount"></span> items. 
                    <span id="createdCount"></span> inventory items already created.
                </span>
            </label>
        </div>
        
        <div id="inventoryError" class="alert alert-error mt-4 hidden">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span id="errorMessage"></span>
        </div>
        
        <div id="inventorySuccess" class="alert alert-success mt-4 hidden">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span id="successMessage"></span>
        </div>
        
        <div class="modal-action">
            <button type="button" onclick="document.getElementById('inventory_modal').close()" class="btn">Cancel</button>
            <button type="button" onclick="createInventoryItems()" class="btn btn-primary">
                Create Inventory
            </button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
let currentItemId = null;

function openInventoryModal(itemId, productName, orderedQuantity, createdCount) {
    currentItemId = itemId;
    document.getElementById('modalProductName').textContent = productName;
    document.getElementById('receivedCount').textContent = orderedQuantity;
    document.getElementById('createdCount').textContent = createdCount;
    document.getElementById('serialNumbers').value = '';
    document.getElementById('inventoryError').classList.add('hidden');
    document.getElementById('inventorySuccess').classList.add('hidden');
    document.getElementById('inventory_modal').showModal();
}

function createInventoryItems() {
    const serialNumbers = document.getElementById('serialNumbers').value.trim();
    if (!serialNumbers) {
        showError('Please enter at least one serial number.');
        return;
    }
    
    // Disable button and show loading
    const button = event.target;
    button.disabled = true;
    button.innerHTML = '<span class="loading loading-spinner"></span> Creating...';
    
    // Send AJAX request
    fetch(`{% url 'purchases:create_inventory_items' order.pk 0 %}`.replace('0', currentItemId), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            serial_numbers: serialNumbers
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            document.getElementById('serialNumbers').value = '';
            // Reload page after 2 seconds to show updated counts
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showError(data.error);
        }
    })
    .catch(error => {
        showError('An error occurred. Please try again.');
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = 'Create Inventory';
    });
}

function showError(message) {
    const errorDiv = document.getElementById('inventoryError');
    document.getElementById('errorMessage').textContent = message;
    errorDiv.classList.remove('hidden');
    document.getElementById('inventorySuccess').classList.add('hidden');
}

function showSuccess(message) {
    const successDiv = document.getElementById('inventorySuccess');
    document.getElementById('successMessage').textContent = message;
    successDiv.classList.remove('hidden');
    document.getElementById('inventoryError').classList.add('hidden');
}
</script>
{% endblock %}