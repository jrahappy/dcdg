{% extends 'accounts/account_base.html' %}
{% load static %}

{% block account_content %}
<h2 class="text-2xl font-bold text-gray-900 mb-6">Sender Information</h2>

<!-- Business Information Section -->
<div class="mb-8">
    <h3 class="text-lg font-medium text-gray-900 mb-4">Business Information</h3>
    
    <form method="POST" class="space-y-6">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_business">
        
        <div>
            <label for="business_name" class="block text-sm font-medium text-gray-700">
                Business Name <span class="text-red-500">*</span>
            </label>
            <input type="text" 
                   name="business_name" 
                   id="business_name" 
                   value="{{ sender_info.business_name }}"
                   required
                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
        </div>
        
        <div>
            <label for="business_address" class="block text-sm font-medium text-gray-700">
                Business Address
            </label>
            <textarea name="business_address" 
                      id="business_address" 
                      rows="3"
                      placeholder="123 Main St, Suite 100&#10;City, State 12345"
                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">{{ sender_info.business_address }}</textarea>
        </div>
        
        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
            <div>
                <label for="business_phone" class="block text-sm font-medium text-gray-700">
                    Business Phone
                </label>
                <input type="tel" 
                       name="business_phone" 
                       id="business_phone" 
                       value="{{ sender_info.business_phone }}"
                       placeholder="(555) 123-4567"
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
            </div>
            
            <div>
                <label for="business_website" class="block text-sm font-medium text-gray-700">
                    Business Website
                </label>
                <input type="url" 
                       name="business_website" 
                       id="business_website" 
                       value="{{ sender_info.business_website }}"
                       placeholder="https://example.com"
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
            </div>
        </div>
        
        <div>
            <button type="submit" class="inline-flex justify-center rounded-md border border-transparent bg-blue-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                <i class="fas fa-save mr-2"></i>
                Save Business Information
            </button>
        </div>
    </form>
</div>

<hr class="my-8 border-gray-200">

<!-- Email Addresses Section -->
<div>
    <div class="mb-4">
        <h3 class="text-lg font-medium text-gray-900">Email Addresses</h3>
        <p class="mt-1 text-sm text-gray-600">Configure sender email addresses with SMTP settings</p>
    </div>
    
    <!-- Email List -->
    <div class="space-y-4 mb-6">
        {% for email in sender_emails %}
        <div class="border {% if email.is_primary %}border-blue-300 bg-blue-50{% else %}border-gray-200 bg-white{% endif %} rounded-lg overflow-hidden">
            <div class="p-4">
                <div class="flex items-start justify-between">
                    <div>
                        <div class="font-medium text-gray-900">
                            {% if email.display_name %}
                                {{ email.display_name }} &lt;{{ email.email }}&gt;
                            {% else %}
                                {{ email.email }}
                            {% endif %}
                        </div>
                        <div class="mt-1 flex items-center space-x-2">
                            {% if email.is_primary %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    <i class="fas fa-star mr-1"></i>
                                    Primary
                                </span>
                            {% endif %}
                            {% if email.is_verified %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    <i class="fas fa-check-circle mr-1"></i>
                                    Verified
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                    <i class="fas fa-exclamation-circle mr-1"></i>
                                    Unverified
                                </span>
                            {% endif %}
                        </div>
                        <div class="mt-2 text-sm text-gray-600">
                            <span class="font-medium">SMTP:</span> {{ email.smtp_host }}:{{ email.smtp_port }} ({{ email.get_smtp_encryption_display }})
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <button type="button" 
                                onclick="openEmailModal({{ email.id }}, '{{ email.email|escapejs }}', '{{ email.display_name|escapejs }}', '{{ email.smtp_host|escapejs }}', {{ email.smtp_port }}, '{{ email.smtp_username|escapejs }}', '{{ email.smtp_encryption }}')"
                                class="inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <i class="fas fa-cog mr-1"></i>
                            Configure
                        </button>
                        
                        {% if not email.is_primary %}
                        <form method="POST" class="inline">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="set_primary">
                            <input type="hidden" name="email_id" value="{{ email.id }}">
                            <button type="submit" class="inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                Set as Primary
                            </button>
                        </form>
                        {% endif %}
                        
                        <form method="POST" class="inline">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="test_email">
                            <input type="hidden" name="email_id" value="{{ email.id }}">
                            <button type="submit" class="inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                <i class="fas fa-flask mr-1"></i>
                                Test
                            </button>
                        </form>
                        
                        {% if not email.is_primary or sender_emails.count > 1 %}
                        <form method="POST" class="inline">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="delete_email">
                            <input type="hidden" name="email_id" value="{{ email.id }}">
                            <button type="submit" 
                                    onclick="return confirm('Are you sure you want to remove this email?')"
                                    class="inline-flex items-center px-3 py-1.5 border border-red-300 shadow-sm text-xs font-medium rounded text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
                
                {% if email.last_verified %}
                <div class="mt-2 text-sm text-gray-600">
                    <i class="fas fa-info-circle mr-1"></i>
                    Last verified: {{ email.last_verified|date:"M d, Y g:i A" }}
                </div>
                {% endif %}
                
                {% if email.verification_error %}
                <div class="mt-3 rounded-md bg-red-50 p-3">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-circle text-red-400"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-red-800">Last test failed</h3>
                            <div class="mt-1 text-sm text-red-700">
                                <p>{{ email.verification_error }}</p>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="text-center py-12 bg-gray-50 rounded-lg">
            <i class="fas fa-envelope text-4xl text-gray-400 mb-4"></i>
            <p class="text-gray-500">No email addresses configured yet.</p>
            <p class="text-sm text-gray-400 mt-1">Add your first email address below.</p>
        </div>
        {% endfor %}
    </div>
    
    <!-- Add Email Form -->
    <div class="bg-gray-50 rounded-lg p-6">
        <h4 class="text-sm font-medium text-gray-900 mb-4">Add New Email Address</h4>
        
        <form method="POST" class="space-y-4">
            {% csrf_token %}
            <input type="hidden" name="action" value="add_email">
            
            <!-- Email Provider Preset -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email Provider</label>
                <div class="grid grid-cols-2 gap-2 sm:grid-cols-4">
                    <button type="button" onclick="setSmtpPreset('gmail')" 
                            class="inline-flex justify-center items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fab fa-google mr-2"></i>Gmail
                    </button>
                    <button type="button" onclick="setSmtpPreset('outlook')" 
                            class="inline-flex justify-center items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fab fa-microsoft mr-2"></i>Outlook
                    </button>
                    <button type="button" onclick="setSmtpPreset('yahoo')" 
                            class="inline-flex justify-center items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fab fa-yahoo mr-2"></i>Yahoo
                    </button>
                    <button type="button" onclick="setSmtpPreset('custom')" 
                            class="inline-flex justify-center items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fas fa-server mr-2"></i>Custom
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                <div>
                    <label for="display_name" class="block text-sm font-medium text-gray-700">
                        Display Name (Optional)
                    </label>
                    <input type="text" 
                           name="display_name" 
                           id="display_name"
                           placeholder="John Doe"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                </div>
                
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">
                        Email Address <span class="text-red-500">*</span>
                    </label>
                    <input type="email" 
                           name="email" 
                           id="email"
                           placeholder="john@example.com"
                           required
                           onchange="updateSmtpUsername(this.value)"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                </div>
                
                <div>
                    <label for="smtp_host" class="block text-sm font-medium text-gray-700">
                        SMTP Host <span class="text-red-500">*</span>
                    </label>
                    <input type="text" 
                           name="smtp_host" 
                           id="smtp_host"
                           placeholder="smtp.gmail.com"
                           required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                </div>
                
                <div>
                    <label for="smtp_port" class="block text-sm font-medium text-gray-700">
                        SMTP Port <span class="text-red-500">*</span>
                    </label>
                    <input type="number" 
                           name="smtp_port" 
                           id="smtp_port"
                           value="587"
                           required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                </div>
                
                <div>
                    <label for="smtp_username" class="block text-sm font-medium text-gray-700">
                        SMTP Username <span class="text-red-500">*</span>
                    </label>
                    <input type="text" 
                           name="smtp_username" 
                           id="smtp_username"
                           placeholder="john@example.com"
                           required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                </div>
                
                <div>
                    <label for="smtp_password" class="block text-sm font-medium text-gray-700">
                        SMTP Password <span class="text-red-500">*</span>
                    </label>
                    <input type="password" 
                           name="smtp_password" 
                           id="smtp_password"
                           placeholder="App-specific password"
                           required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                </div>
                
                <div>
                    <label for="smtp_encryption" class="block text-sm font-medium text-gray-700">
                        Encryption <span class="text-red-500">*</span>
                    </label>
                    <select name="smtp_encryption" 
                            id="smtp_encryption"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        <option value="tls">STARTTLS (Port 587)</option>
                        <option value="ssl">SSL/TLS (Port 465)</option>
                        <option value="none">None (Port 25)</option>
                    </select>
                </div>
            </div>
            
            <div>
                <button type="submit" class="inline-flex justify-center rounded-md border border-transparent bg-blue-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    <i class="fas fa-plus mr-2"></i>
                    Add Email Address
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Email Configuration Modal -->
<div id="emailModal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <!-- Background overlay -->
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>

        <!-- This element is to trick the browser into centering the modal contents. -->
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

        <!-- Modal panel -->
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <form method="POST" id="emailConfigForm">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_email">
                <input type="hidden" name="email_id" id="modal_email_id">
                
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4" id="modal-title">
                        Configure Email SMTP Settings
                    </h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Email Address</label>
                            <input type="email" id="modal_email" disabled 
                                   class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm sm:text-sm">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Display Name</label>
                            <input type="text" name="display_name" id="modal_display_name"
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">SMTP Host</label>
                                <input type="text" name="smtp_host" id="modal_smtp_host" required
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700">SMTP Port</label>
                                <input type="number" name="smtp_port" id="modal_smtp_port" required
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">SMTP Username</label>
                            <input type="text" name="smtp_username" id="modal_smtp_username" required
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">SMTP Password</label>
                            <input type="password" name="smtp_password" id="modal_smtp_password"
                                   placeholder="Leave empty to keep current password"
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Encryption</label>
                            <select name="smtp_encryption" id="modal_smtp_encryption"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                <option value="none">None</option>
                                <option value="ssl">SSL/TLS</option>
                                <option value="tls">STARTTLS</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="submit" 
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                        <i class="fas fa-save mr-2"></i>
                        Save Changes
                    </button>
                    <button type="button" onclick="closeEmailModal()"
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Info Box -->
<div class="mt-8 rounded-md bg-blue-50 p-4">
    <div class="flex">
        <div class="flex-shrink-0">
            <i class="fas fa-info-circle text-blue-400"></i>
        </div>
        <div class="ml-3">
            <h3 class="text-sm font-medium text-blue-800">About Sender Information</h3>
            <div class="mt-2 text-sm text-blue-700">
                <p class="mb-2">This information will be used when sending email campaigns:</p>
                <ul class="list-disc list-inside space-y-1">
                    <li>The business name and address will appear in the email footer</li>
                    <li>The primary email address will be used as the "From" address</li>
                    <li>Additional email addresses can be used for different campaigns</li>
                    <li>Email verification helps improve deliverability</li>
                    <li>For Gmail, use an App Password instead of your regular password</li>
                    <li>For Outlook/Office 365, enable "Authenticated SMTP" in your account</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // SMTP Presets
    const smtpPresets = {% if smtp_presets %}{{ smtp_presets|safe }}{% else %}{}{% endif %};
    
    // Define all functions in global scope
    function setSmtpPreset(provider) {
        const preset = smtpPresets[provider];
        if (preset) {
            document.getElementById('smtp_host').value = preset.host;
            document.getElementById('smtp_port').value = preset.port;
            document.getElementById('smtp_encryption').value = preset.encryption;
            
            // Update encryption based on port
            updateEncryptionByPort(preset.port);
        }
    }
    
    function updateSmtpUsername(email) {
        const usernameField = document.getElementById('smtp_username');
        if (!usernameField.value) {
            usernameField.value = email;
        }
    }
    
    function updateEncryptionByPort(port) {
        const encryptionField = document.getElementById('smtp_encryption');
        if (encryptionField) {
            if (port == 465) {
                encryptionField.value = 'ssl';
            } else if (port == 587) {
                encryptionField.value = 'tls';
            } else if (port == 25) {
                encryptionField.value = 'none';
            }
        }
    }
    
    // Modal functions
    function openEmailModal(emailId, email, displayName, smtpHost, smtpPort, smtpUsername, smtpEncryption) {
        // Set form values
        document.getElementById('modal_email_id').value = emailId;
        document.getElementById('modal_email').value = email;
        document.getElementById('modal_display_name').value = displayName || '';
        document.getElementById('modal_smtp_host').value = smtpHost;
        document.getElementById('modal_smtp_port').value = smtpPort;
        document.getElementById('modal_smtp_username').value = smtpUsername;
        document.getElementById('modal_smtp_encryption').value = smtpEncryption;
        
        // Clear password field
        document.getElementById('modal_smtp_password').value = '';
        
        // Show modal
        document.getElementById('emailModal').classList.remove('hidden');
    }
    
    function closeEmailModal() {
        document.getElementById('emailModal').classList.add('hidden');
    }
    
    // Wait for DOM to be loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-save notification
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', function() {
                // Show loading state on buttons
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn && !submitBtn.disabled) {
                    const originalContent = submitBtn.innerHTML;
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
                }
            });
        });
        
        // Update encryption based on port changes
        const smtpPortField = document.getElementById('smtp_port');
        if (smtpPortField) {
            smtpPortField.addEventListener('change', function() {
                updateEncryptionByPort(this.value);
            });
        }
        
        // Modal port change listener
        const modalSmtpPortField = document.getElementById('modal_smtp_port');
        if (modalSmtpPortField) {
            modalSmtpPortField.addEventListener('change', function() {
                const modalEncryptionField = document.getElementById('modal_smtp_encryption');
                if (this.value == 465) {
                    modalEncryptionField.value = 'ssl';
                } else if (this.value == 587) {
                    modalEncryptionField.value = 'tls';
                } else if (this.value == 25) {
                    modalEncryptionField.value = 'none';
                }
            });
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('emailModal');
            if (event.target == modal) {
                closeEmailModal();
            }
        }
    });
</script>
{% endblock %}