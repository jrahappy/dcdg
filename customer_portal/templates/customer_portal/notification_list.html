{% extends 'customer_portal/base.html' %}

{% block account_page_title %}Notifications{% endblock %}

{% block account_content %}
<!-- Breadcrumb -->
<div class="breadcrumbs text-sm mb-6">
    <ul>
        <li><a href="{% url 'customer_portal:dashboard' %}">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
        </a></li>
        <li>Notifications</li>
    </ul>
</div>

<!-- Page Header -->
<div class="flex justify-between items-center mb-8">
    <div>
        <h1 class="text-3xl font-bold text-gray-900">
            Notifications
            {% if unread_count > 0 %}
            <span class="ml-2 badge badge-error">{{ unread_count }} unread</span>
            {% endif %}
        </h1>
        <p class="mt-2 text-sm text-gray-600">Stay updated with your orders, promotions, and account updates</p>
    </div>
    {% if unread_count > 0 %}
    <form method="post" action="{% url 'customer_portal:notification_mark_all_read' %}" class="inline">
        {% csrf_token %}
        <button type="submit" class="btn btn-outline btn-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Mark all as read
        </button>
    </form>
    {% endif %}
</div>

<!-- Filter Tabs -->
<div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
        <div class="flex flex-col sm:flex-row gap-4">
            <!-- Status Filter -->
            <div class="flex-1">
                <label class="label">
                    <span class="label-text font-semibold">Status</span>
                </label>
                <div class="tabs tabs-boxed">
                    <a href="?status=all{% if filter_type %}&type={{ filter_type }}{% endif %}" 
                       class="tab {% if filter_status == 'all' %}tab-active{% endif %}">
                        All
                    </a>
                    <a href="?status=unread{% if filter_type %}&type={{ filter_type }}{% endif %}" 
                       class="tab {% if filter_status == 'unread' %}tab-active{% endif %}">
                        Unread
                    </a>
                    <a href="?status=read{% if filter_type %}&type={{ filter_type }}{% endif %}" 
                       class="tab {% if filter_status == 'read' %}tab-active{% endif %}">
                        Read
                    </a>
                </div>
            </div>
            
            <!-- Type Filter -->
            <div class="flex-1">
                <label class="label">
                    <span class="label-text font-semibold">Type</span>
                </label>
                <select onchange="window.location.href='?status={{ filter_status }}&type=' + this.value" 
                        class="select select-bordered w-full">
                    <option value="all">All types</option>
                    {% for type_value, type_label in notification_types %}
                    <option value="{{ type_value }}" {% if filter_type == type_value %}selected{% endif %}>
                        {{ type_label }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Notifications List -->
{% if notifications %}
<div class="space-y-4">
    {% for notification in notifications %}
    <div class="card bg-base-100 shadow-xl {% if not notification.is_read %}ring-2 ring-primary{% endif %}" 
         data-notification-id="{{ notification.pk }}">
        <div class="card-body">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <!-- Notification Header -->
                    <div class="flex items-center gap-2">
                        <h2 class="card-title {% if not notification.is_read %}text-gray-900{% else %}text-gray-700{% endif %}">
                            {{ notification.title }}
                        </h2>
                        {% if not notification.is_read %}
                        <span class="badge badge-primary badge-sm animate-pulse">New</span>
                        {% endif %}
                    </div>
                    
                    <!-- Metadata -->
                    <div class="mt-2 flex flex-wrap gap-3 text-sm text-gray-600">
                        <span class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            {{ notification.created_at|date:"M d, Y g:i A" }}
                        </span>
                        <span class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                            </svg>
                            {{ notification.get_notification_type_display }}
                        </span>
                        {% if notification.priority == 'high' %}
                        <span class="badge badge-error badge-sm">High Priority</span>
                        {% elif notification.priority == 'medium' %}
                        <span class="badge badge-warning badge-sm">Medium Priority</span>
                        {% endif %}
                    </div>
                    
                    <!-- Message -->
                    <p class="mt-3 text-gray-600">{{ notification.message|truncatewords:50 }}</p>
                </div>
                
                <!-- Actions -->
                <div class="flex flex-col gap-2 ml-4">
                    <a href="{% url 'customer_portal:notification_detail' notification.pk %}" 
                       class="btn btn-primary btn-sm">
                        {% if notification.link %}View{% else %}Details{% endif %}
                    </a>
                    {% if not notification.is_read %}
                    <button onclick="markAsRead({{ notification.pk }})" 
                            class="btn btn-ghost btn-sm">
                        Mark as read
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Pagination -->
{% if is_paginated %}
<div class="flex justify-center mt-8">
    <div class="join">
        {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}{% if filter_status != 'all' %}&status={{ filter_status }}{% endif %}{% if filter_type %}&type={{ filter_type }}{% endif %}" 
           class="join-item btn">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            Previous
        </a>
        {% endif %}
        
        <button class="join-item btn btn-active">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</button>
        
        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if filter_status != 'all' %}&status={{ filter_status }}{% endif %}{% if filter_type %}&type={{ filter_type }}{% endif %}" 
           class="join-item btn">
            Next
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
        </a>
        {% endif %}
    </div>
</div>
{% endif %}

{% else %}
<!-- Empty State -->
<div class="card bg-base-100 shadow-xl">
    <div class="card-body text-center py-12">
        <div class="flex justify-center mb-4">
            <svg class="h-24 w-24 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
            </svg>
        </div>
        <h3 class="text-lg font-medium text-gray-900">No notifications</h3>
        <p class="mt-2 text-sm text-gray-500">
            {% if filter_status == 'unread' %}
                You don't have any unread notifications.
            {% elif filter_status == 'read' %}
                You haven't read any notifications yet.
            {% else %}
                You don't have any notifications yet. We'll notify you when there's something new.
            {% endif %}
        </p>
    </div>
</div>
{% endif %}

<!-- Notification Tips -->
<div class="alert alert-info mt-8">
    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    <div>
        <h3 class="font-bold">Notification Settings</h3>
        <div class="text-xs mt-2">
            <ul class="space-y-1">
                <li>• You'll receive notifications for order updates, promotions, and account changes</li>
                <li>• Click on any notification to view full details</li>
                <li>• Unread notifications are highlighted with a blue border</li>
                <li>• Use filters to find specific types of notifications</li>
            </ul>
        </div>
    </div>
</div>

<script>
function markAsRead(notificationId) {
    fetch(`/account/notifications/${notificationId}/mark-read/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove visual indicators
            const notificationEl = document.querySelector(`[data-notification-id="${notificationId}"]`);
            notificationEl.classList.remove('ring-2', 'ring-primary');
            
            // Update the notification card
            const newBadge = notificationEl.querySelector('.badge.badge-primary');
            if (newBadge) {
                newBadge.remove();
            }
            
            // Update button
            const markButton = notificationEl.querySelector('button[onclick*="markAsRead"]');
            if (markButton) {
                markButton.remove();
            }
            
            // Optionally reload to update counts
            setTimeout(() => location.reload(), 500);
        }
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}