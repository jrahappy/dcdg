{% extends 'customer_portal/base.html' %}

{% block title %}Notifications{% endblock %}

{% block content %}
<div class="mb-8">
    <div class="sm:flex sm:items-center sm:justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Notifications</h1>
            <p class="mt-1 text-sm text-gray-600">
                Stay updated with your orders, promotions, and account updates.
                {% if unread_count > 0 %}
                <span class="ml-2 inline-flex items-center rounded-full bg-red-100 px-2.5 py-0.5 text-xs font-medium text-red-800">
                    {{ unread_count }} unread
                </span>
                {% endif %}
            </p>
        </div>
        {% if unread_count > 0 %}
        <div class="mt-4 sm:mt-0">
            <form method="post" action="{% url 'customer_portal:notification_mark_all_read' %}" class="inline">
                {% csrf_token %}
                <button type="submit" class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                    Mark all as read
                </button>
            </form>
        </div>
        {% endif %}
    </div>
</div>

<!-- Filters -->
<div class="mb-6 bg-white shadow sm:rounded-lg">
    <div class="px-4 py-5 sm:p-6">
        <div class="sm:flex sm:items-center sm:space-x-6">
            <div>
                <label class="block text-sm font-medium text-gray-700">Status</label>
                <div class="mt-2 flex space-x-4">
                    <a href="?status=all{% if filter_type %}&type={{ filter_type }}{% endif %}" 
                       class="{% if filter_status == 'all' %}bg-indigo-100 text-indigo-700{% else %}text-gray-500 hover:text-gray-700{% endif %} px-3 py-2 text-sm font-medium rounded-md">
                        All
                    </a>
                    <a href="?status=unread{% if filter_type %}&type={{ filter_type }}{% endif %}" 
                       class="{% if filter_status == 'unread' %}bg-indigo-100 text-indigo-700{% else %}text-gray-500 hover:text-gray-700{% endif %} px-3 py-2 text-sm font-medium rounded-md">
                        Unread
                    </a>
                    <a href="?status=read{% if filter_type %}&type={{ filter_type }}{% endif %}" 
                       class="{% if filter_status == 'read' %}bg-indigo-100 text-indigo-700{% else %}text-gray-500 hover:text-gray-700{% endif %} px-3 py-2 text-sm font-medium rounded-md">
                        Read
                    </a>
                </div>
            </div>
            
            <div>
                <label for="type-filter" class="block text-sm font-medium text-gray-700">Type</label>
                <select id="type-filter" onchange="window.location.href='?status={{ filter_status }}&type=' + this.value" 
                        class="mt-2 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm">
                    <option value="all">All types</option>
                    {% for type_value, type_label in notification_types %}
                    <option value="{{ type_value }}" {% if filter_type == type_value %}selected{% endif %}>
                        {{ type_label }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Notifications List -->
{% if notifications %}
<div class="space-y-4">
    {% for notification in notifications %}
    <div class="bg-white shadow sm:rounded-lg overflow-hidden {% if not notification.is_read %}ring-2 ring-indigo-500{% endif %}" 
         data-notification-id="{{ notification.pk }}">
        <div class="px-4 py-5 sm:p-6">
            <div class="sm:flex sm:items-start sm:justify-between">
                <div class="flex-1">
                    <div class="flex items-center">
                        <h3 class="text-lg font-medium {% if not notification.is_read %}text-gray-900{% else %}text-gray-700{% endif %}">
                            {{ notification.title }}
                        </h3>
                        {% if not notification.is_read %}
                        <span class="ml-2 flex h-3 w-3">
                            <span class="animate-ping absolute inline-flex h-3 w-3 rounded-full bg-indigo-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-3 w-3 bg-indigo-500"></span>
                        </span>
                        {% endif %}
                    </div>
                    
                    <div class="mt-2 flex items-center space-x-4 text-sm text-gray-500">
                        <span>{{ notification.created_at|date:"M d, Y g:i A" }}</span>
                        <span>•</span>
                        <span>{{ notification.get_notification_type_display }}</span>
                        {% if notification.priority == 'high' %}
                        <span>•</span>
                        <span class="inline-flex items-center rounded-full bg-red-100 px-2 py-0.5 text-xs font-medium text-red-800">
                            High Priority
                        </span>
                        {% elif notification.priority == 'medium' %}
                        <span>•</span>
                        <span class="inline-flex items-center rounded-full bg-yellow-100 px-2 py-0.5 text-xs font-medium text-yellow-800">
                            Medium Priority
                        </span>
                        {% endif %}
                    </div>
                    
                    <p class="mt-3 text-sm text-gray-600">{{ notification.message }}</p>
                </div>
                
                <div class="mt-4 sm:mt-0 sm:ml-6 sm:flex-shrink-0">
                    <div class="flex flex-col space-y-2">
                        <a href="{% url 'customer_portal:notification_detail' notification.pk %}" 
                           class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                            {% if notification.link %}View{% else %}Details{% endif %}
                        </a>
                        {% if not notification.is_read %}
                        <button onclick="markAsRead({{ notification.pk }})" 
                                class="inline-flex items-center rounded-md px-3 py-2 text-sm font-semibold text-indigo-600 hover:text-indigo-500">
                            Mark as read
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Pagination -->
{% if is_paginated %}
<nav class="mt-6 flex items-center justify-between border-t border-gray-200 px-4 sm:px-0">
    <div class="-mt-px flex w-0 flex-1">
        {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}{% if filter_status != 'all' %}&status={{ filter_status }}{% endif %}{% if filter_type %}&type={{ filter_type }}{% endif %}" 
           class="inline-flex items-center border-t-2 border-transparent pr-1 pt-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">
            <svg class="mr-3 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M18 10a.75.75 0 01-.75.75H4.66l2.1 1.95a.75.75 0 11-1.02 1.1l-3.5-3.25a.75.75 0 010-1.1l3.5-3.25a.75.75 0 111.02 1.1l-2.1 1.95h12.59A.75.75 0 0118 10z" clip-rule="evenodd" />
            </svg>
            Previous
        </a>
        {% endif %}
    </div>
    <div class="hidden md:-mt-px md:flex">
        {% for num in page_obj.paginator.page_range %}
        <a href="?page={{ num }}{% if filter_status != 'all' %}&status={{ filter_status }}{% endif %}{% if filter_type %}&type={{ filter_type }}{% endif %}" 
           class="{% if page_obj.number == num %}border-indigo-500 text-indigo-600{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %} inline-flex items-center border-t-2 px-4 pt-4 text-sm font-medium">
            {{ num }}
        </a>
        {% endfor %}
    </div>
    <div class="-mt-px flex w-0 flex-1 justify-end">
        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if filter_status != 'all' %}&status={{ filter_status }}{% endif %}{% if filter_type %}&type={{ filter_type }}{% endif %}" 
           class="inline-flex items-center border-t-2 border-transparent pl-1 pt-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">
            Next
            <svg class="ml-3 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M2 10a.75.75 0 01.75-.75h12.59l-2.1-1.95a.75.75 0 111.02-1.1l3.5 3.25a.75.75 0 010 1.1l-3.5 3.25a.75.75 0 11-1.02-1.1l2.1-1.95H2.75A.75.75 0 012 10z" clip-rule="evenodd" />
            </svg>
        </a>
        {% endif %}
    </div>
</nav>
{% endif %}

{% else %}
<div class="bg-white shadow sm:rounded-lg">
    <div class="px-4 py-5 sm:p-6">
        <div class="text-center py-12">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No notifications</h3>
            <p class="mt-1 text-sm text-gray-500">
                {% if filter_status == 'unread' %}
                    You don't have any unread notifications.
                {% elif filter_status == 'read' %}
                    You haven't read any notifications yet.
                {% else %}
                    You don't have any notifications yet.
                {% endif %}
            </p>
        </div>
    </div>
</div>
{% endif %}

<script>
function markAsRead(notificationId) {
    fetch(`/account/notifications/${notificationId}/mark-read/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove visual indicators
            const notificationEl = document.querySelector(`[data-notification-id="${notificationId}"]`);
            notificationEl.classList.remove('ring-2', 'ring-indigo-500');
            
            // Update unread count
            location.reload();
        }
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}