{% extends 'customer_portal/base.html' %}

{% block account_page_title %}Order {{ order.invoice_number }}{% endblock %}

{% block extra_head %}
<style>
@media print {
    /* Hide non-essential elements */
    .no-print, 
    .breadcrumbs,
    .btn,
    .navbar,
    aside,
    footer {
        display: none !important;
    }
    
    /* Reset page margins */
    @page {
        margin: 0.5in;
    }
    
    /* Make content full width */
    .print-full-width {
        max-width: 100% !important;
        padding: 0 !important;
    }
    
    /* Improve readability */
    body {
        font-size: 12pt;
        line-height: 1.5;
    }
    
    /* Ensure cards don't break across pages */
    .card {
        page-break-inside: avoid;
        box-shadow: none !important;
        border: 1px solid #ddd !important;
    }
    
    /* Table styling for print */
    table {
        width: 100%;
        border-collapse: collapse;
    }
    
    th, td {
        border: 1px solid #ddd;
        padding: 8px;
    }
    
    /* Show print-only elements */
    .print-only {
        display: block !important;
    }
}

/* Hide print-only elements on screen */
@media screen {
    .print-only {
        display: none;
    }
}
</style>
{% endblock %}

{% block account_content %}
<!-- Breadcrumb -->
<div class="breadcrumbs text-sm mb-6">
    <ul>
        <li><a href="{% url 'customer_portal:dashboard' %}">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
        </a></li>
        <li><a href="{% url 'customer_portal:order_list' %}">Orders</a></li>
        <li>{{ order.invoice_number }}</li>
    </ul>
</div>

<!-- Print-only Header -->
<div class="print-only mb-6">
    <h1 class="text-3xl font-bold">Order Invoice</h1>
    <p class="text-lg mt-2">Order #{{ order.invoice_number }}</p>
    <p class="text-base text-gray-600">Date: {{ order.created_at|date:"F d, Y" }}</p>
</div>

<!-- Order Header -->
<div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="card-title text-2xl">Order {{ order.invoice_number }}</h1>
                <p class="text-base-content/60">Order placed on {{ order.created_at|date:"F d, Y" }}</p>
            </div>
            <div class="flex gap-2 no-print">
                <button onclick="window.print()" class="btn btn-outline">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                    </svg>
                    Print Invoice
                </button>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-4">
            <div>
                <p class="text-sm font-semibold text-base-content/60">Order Status</p>
                <div class="badge 
                    {% if order.status == 'draft' %}badge-ghost
                    {% elif order.status == 'pending' %}badge-warning
                    {% elif order.status == 'sent' %}badge-info
                    {% elif order.status == 'paid' %}badge-success
                    {% elif order.status == 'cancelled' %}badge-error
                    {% else %}badge-ghost{% endif %} badge-lg mt-1">
                    {{ order.get_status_display }}
                </div>
            </div>
            
            <div>
                <p class="text-sm font-semibold text-base-content/60">Order Total</p>
                <p class="text-lg font-bold">${{ order.total_amount|floatformat:2 }}</p>
            </div>
            
            <div>
                <p class="text-sm font-semibold text-base-content/60">Order Date</p>
                <p class="text-base">{{ order.invoice_date|date:"F d, Y" }}</p>
            </div>
            
            <div>
                <p class="text-sm font-semibold text-base-content/60">Invoice Number</p>
                <p class="text-base font-mono">#{{ order.invoice_number }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Order Timeline -->
{% if order.shipping_status != 'cancelled' %}
<div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
        <h2 class="card-title">Tracking information</h2>
        
        {% if tracking_info %}
        {% for tracking in tracking_info %}
        <div class="border-b border-base-content/10 py-4 last:border-b-0">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <p class="text-sm text-base-content/60">Carrier</p>
                    <p class="font-semibold">{{ tracking.get_carrier_display|default:tracking.carrier|upper }}</p>
                </div>
                <div>
                    <p class="text-sm text-base-content/60">Tracking Number</p>
                    <p class="font-mono">{{ tracking.tracking_number|default:"Not provided" }}</p>
                </div>
                <div>
                    <p class="text-sm text-base-content/60">Track Package</p>
                    {% with tracking_url=tracking.get_tracking_url %}
                    {% if tracking_url %}
                    <a href="{{ tracking_url }}" target="_blank" class="btn btn-sm btn-outline btn-primary mt-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                        </svg>
                        {% if tracking.tracking_number %}Track{% else %}{{ tracking.get_carrier_display }} Tracking{% endif %}
                    </a>
                    {% else %}
                    <p class="text-sm text-base-content/40 mt-1">No tracking available</p>
                    {% endif %}
                    {% endwith %}
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <p class="text-base-content/60">No tracking information available for this order yet.</p>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Order Items -->
<div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
        <h2 class="card-title">Order Items</h2>
        
        <div class="overflow-x-auto">
            <table class="table">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Details</th>
                        <th>Quantity</th>
                        <th>Shipping Status</th>
                        <th class="text-right">Price</th>
                        <th class="text-right">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in order.items.all %}
                    <tr>
                        <td>
                            <div class="flex items-center gap-3">
                                <div class="avatar no-print">
                                    <div class="mask mask-squircle w-12 h-12 bg-base-200">
                                        {% if item.product %}
                                            {% if item.product.main_image %}
                                            <img src="{{ item.product.main_image.url }}" alt="{{ item.description }}" />
                                            {% elif item.product.images.all %}
                                            {% with item.product.images.all.0 as first_image %}
                                            <img src="{{ first_image.image.url }}" alt="{{ item.description }}" />
                                            {% endwith %}
                                            {% else %}
                                            <div class="w-full h-full flex items-center justify-center">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-base-content/30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                                                </svg>
                                            </div>
                                            {% endif %}
                                        {% else %}
                                        <div class="w-full h-full flex items-center justify-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-base-content/30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                                            </svg>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div>
                                    {% if item.product %}
                                    <a href="{% url 'shop:product_detail' item.product.id %}" class="font-bold hover:link-primary no-print">
                                        {{ item.description }}
                                    </a>
                                    <span class="font-bold print-only">{{ item.description }}</span>
                                    {% else %}
                                    <span class="font-bold">{{ item.description }}</span>
                                    {% endif %}
                                    {% if item.product_options %}
                                    <div class="text-sm text-primary">
                                        {% for key, value in item.product_options.items %}
                                            {{ key }}: {{ value }}{% if not forloop.last %}, {% endif %}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if item.product %}
                            <span class="text-sm text-base-content/60">SKU: {{ item.product.sku }}</span>
                            {% else %}
                            <span class="text-sm text-base-content/60">-</span>
                            {% endif %}
                        </td>
                        <td>{{ item.quantity }}</td>
                        <td>
                            {% with item.shipment_items.first as shipment_item %}
                            {% if shipment_item %}
                                {% with shipment_item.shipment as shipment %}
                                <div class="badge 
                                    {% if shipment.status == 'awaiting_shipment' %}badge-ghost badge-sm
                                    {% elif shipment.status == 'shipped' or shipment.status == 'in_transit' %}badge-info badge-sm
                                    {% elif shipment.status == 'out_for_delivery' %}badge-accent badge-sm
                                    {% elif shipment.status == 'delivered' %}badge-success badge-sm
                                    {% elif shipment.status == 'failed' or shipment.status == 'returned' %}badge-error badge-sm
                                    {% else %}badge-ghost badge-sm{% endif %}">
                                    {{ shipment.get_status_display }}
                                </div>
                                {% if shipment.tracking_number %}
                                <div class="text-xs text-base-content/60 mt-1">
                                    {{ shipment.get_carrier_display }}: {{ shipment.tracking_number }}
                                </div>
                                {% endif %}
                                {% endwith %}
                            {% else %}
                                <div class="badge badge-ghost badge-sm">Awaiting Shipment</div>
                            {% endif %}
                            {% endwith %}
                        </td>
                        <td class="text-right">${{ item.unit_price|floatformat:2 }}</td>
                        <td class="text-right font-semibold">${{ item.line_total|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Order Summary -->
        <div class="divider"></div>
        <div class="grid grid-cols-2 gap-2 max-w-sm ml-auto">
            <div class="text-right">Subtotal:</div>
            <div class="text-right">${{ order.subtotal|floatformat:2 }}</div>
            
            {% if order.tax_amount %}
            <div class="text-right">Tax:</div>
            <div class="text-right">${{ order.tax_amount|floatformat:2 }}</div>
            {% endif %}
            
            {% if order.shipping_cost %}
            <div class="text-right">Shipping:</div>
            <div class="text-right">${{ order.shipping_cost|floatformat:2 }}</div>
            {% endif %}
            
            <div class="divider col-span-2 my-2"></div>
            
            <div class="text-right font-bold">Order Total:</div>
            <div class="text-right font-bold text-lg">${{ order.total_amount|floatformat:2 }}</div>
        </div>
    </div>
</div>

<!-- Shipping Information -->
<div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
        <h2 class="card-title">Shipping Information</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <h3 class="font-semibold mb-2">Shipping Address</h3>
                <address class="not-italic text-base-content/80">
                    {{ order.first_name }} {{ order.last_name }}<br>
                    {% if order.shipping_address_line1 %}
                        {{ order.shipping_address_line1 }}<br>
                        {% if order.shipping_address_line2 %}{{ order.shipping_address_line2 }}<br>{% endif %}
                        {{ order.shipping_city }}, {{ order.shipping_state }} {{ order.shipping_postal_code }}<br>
                    {% else %}
                        {{ order.billing_address_line1 }}<br>
                        {% if order.billing_address_line2 %}{{ order.billing_address_line2 }}<br>{% endif %}
                        {{ order.billing_city }}, {{ order.billing_state }} {{ order.billing_postal_code }}<br>
                    {% endif %}
                    {% if order.phone %}
                    <span class="text-sm">Phone: {{ order.phone }}</span>
                    {% endif %}
                </address>
            </div>
            
            {% if order.billing_address_line1 %}
            <div>
                <h3 class="font-semibold mb-2">Billing Address</h3>
                <address class="not-italic text-base-content/80">
                    {{ order.first_name }} {{ order.last_name }}<br>
                    {{ order.billing_address_line1 }}<br>
                    {% if order.billing_address_line2 %}{{ order.billing_address_line2 }}<br>{% endif %}
                    {{ order.billing_city }}, {{ order.billing_state }} {{ order.billing_postal_code }}<br>
                    {% if order.phone %}
                    <span class="text-sm">Phone: {{ order.phone }}</span>
                    {% endif %}
                </address>
            </div>
            {% endif %}
            
            <div>
                <h3 class="font-semibold mb-2">Shipping Method</h3>
                <p class="text-base-content/80">{{ order.shipping_method|default:"Standard Shipping" }}</p>
            </div>
            
            <div>
                <h3 class="font-semibold mb-2">Contact Email</h3>
                <p class="text-base-content/80">{{ order.email }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Order Notes -->
{% if order.notes %}
<div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
        <h2 class="card-title">Order Notes</h2>
        <div class="text-base-content/80">
            {{ order.notes|linebreaks }}
        </div>
    </div>
</div>
{% endif %}

<!-- Actions -->
<div class="flex gap-4">
    {% if order.status == 'sent' and order.post_tracking_number %}
    <a href="#" class="btn btn-primary">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        Track Package
    </a>
    {% endif %}
    
    <a href="{% url 'customer_portal:order_list' %}" class="btn btn-outline">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back to Orders
    </a>
</div>
{% endblock %}