{% load static %}
{% load django_vite %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block account_page_title %}My Account{% endblock %} - DCDG Dental Shop</title>
    {% vite_hmr_client %}
    {% vite_asset 'static/js/main.js' %}
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    {% block extra_head %}{% endblock %}
    
    <script>
    // Define shopApp before Alpine.js loads
    window.shopApp = function() {
        return {
            cartCount: 0,
            cartSubtotal: 0,
            cartItemsHtml: '',
            
            init() {
                console.log('Alpine shopApp initialized');
                console.log('Initial cartCount:', this.cartCount);
                this.loadCartSummary();
            },
            
            loadCartSummary() {
                fetch('/cart/?format=json', {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Cart data loaded:', data);
                    const newCount = data.total_items || 0;
                    console.log('Setting cartCount from', this.cartCount, 'to', newCount);
                    this.cartCount = newCount;
                    this.cartSubtotal = data.subtotal ? data.subtotal.toFixed(2) : '0.00';
                    this.cartItemsHtml = data.preview_html || '<p class="text-center py-4 text-base-content/60">Your cart is empty</p>';
                    console.log('Cart count is now:', this.cartCount);
                    console.log('Alpine component data:', this);
                })
                .catch(error => {
                    console.error('Error loading cart:', error);
                });
            },
            
            addToCart(productId, quantity = 1) {
                fetch(`/cart/add/${productId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `quantity=${quantity}`
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Add to cart response:', data);
                    if (data.success) {
                        console.log('Item added successfully, reloading cart summary...');
                        this.loadCartSummary();
                        this.showNotification(data.message || 'Added to cart', 'success');
                    } else {
                        this.showNotification(data.error || 'Failed to add to cart', 'error');
                    }
                })
                .catch(error => {
                    this.showNotification('An error occurred', 'error');
                });
            },
            
            removeFromCart(itemId) {
                fetch(`/cart/remove/${itemId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/x-www-form-urlencoded',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.loadCartSummary();
                        this.showNotification(data.message || 'Item removed from cart', 'success');
                        // Reload the page if we're on the cart page
                        if (window.location.pathname === '/cart/') {
                            window.location.reload();
                        }
                    } else {
                        this.showNotification(data.error || 'Failed to remove item', 'error');
                    }
                })
                .catch(error => {
                    this.showNotification('An error occurred', 'error');
                });
            },
            
            showNotification(message, type = 'info') {
                const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-error' : 'alert-info';
                const notification = document.createElement('div');
                notification.className = `alert ${alertClass} fixed top-20 right-4 z-50 max-w-sm shadow-lg`;
                notification.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                        ${type === 'success' ? 
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />' : 
                        type === 'error' ?
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />' :
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />'
                        }
                    </svg>
                    <span>${message}</span>
                `;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transition = 'opacity 0.3s';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        }
    }
    </script>
    
    <!-- Alpine.js -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script>
    // Register Alpine component when Alpine is ready
    document.addEventListener('alpine:init', () => {
        console.log('Alpine is initializing, registering shopApp');
        Alpine.data('shopApp', window.shopApp);
    });
    </script>
</head>
<body class="bg-base-100" x-data="shopApp" x-init="init()">
    {% include 'shop/navbar.html' %}
    
    <div class="min-h-screen bg-base-200">
        <!-- Main Content with Sidebar -->
        <main class="flex-1">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                    <!-- Left Sidebar -->
                    {% include 'customer_portal/aside.html' %}
                    <!-- Main Content Area -->
                    <div class="lg:col-span-3">
                        {% block account_content %}{% endblock %}
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Global functions that delegate to Alpine component
function addToCart(productId, quantity = 1) {
    // Get the Alpine component instance
    const rootElement = document.querySelector('[x-data]');
    if (rootElement && rootElement._x_dataStack) {
        console.log('Calling Alpine addToCart via global function');
        Alpine.$data(rootElement).addToCart(productId, quantity);
    } else {
        console.error('Could not find Alpine component');
        // Fallback: direct API call
        fetch(`/cart/add/${productId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `quantity=${quantity}`
        })
        .then(response => response.json())
        .then(data => {
            console.log('Add to cart response (fallback):', data);
            if (data.success) {
                // Try to reload cart summary if possible
                window.location.reload();
            }
        });
    }
}

function removeFromCart(itemId) {
    console.log('Removing item:', itemId);
    
    // Direct API call since Alpine might not be accessible from onclick
    fetch(`/cart/remove/${itemId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            // Show notification if Alpine is available
            const shopAppElement = document.querySelector('[x-data*="shopApp"]');
            if (shopAppElement && shopAppElement.__x && shopAppElement.__x.$data) {
                shopAppElement.__x.$data.loadCartSummary();
                shopAppElement.__x.$data.showNotification(data.message || 'Item removed from cart', 'success');
            }
            // Reload the page if we're on the cart page
            if (window.location.pathname.includes('/cart/')) {
                window.location.reload();
            }
        } else {
            alert(data.error || 'Failed to remove item');
        }
    })
    .catch(error => {
        console.error('Error removing item:', error);
        alert('An error occurred while removing the item: ' + error.message);
    });
}

function updateCartItem(itemId, quantity) {
    fetch(`/cart/update/${itemId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `quantity=${quantity}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert(data.error || 'Failed to update quantity');
        }
    })
    .catch(error => {
        alert('An error occurred');
    });
}
</script>

    {% block scripts %}
        <script src="https://cdn.jsdelivr.net/npm/@tailwindplus/elements@1" type="module"></script>
    {% endblock %}
</body>
</html>