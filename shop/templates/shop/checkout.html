{% extends 'shop/base.html' %}
{% load static %}
{% load humanize %}

{% block page_title %}Checkout{% endblock %}

{% block content %}
<div class="min-h-screen">
    <div class="mx-auto max-w-7xl px-4 pb-24 pt-8 sm:px-6 lg:px-8">
        <!-- Breadcrumb -->
        <div class="text-sm breadcrumbs mb-6">
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="{% url 'shop:product_list' %}">Shop</a></li>
                <li><a href="{% url 'shop:cart' %}">Cart</a></li>
                <li>Checkout</li>
            </ul>
        </div>
        
        <h1 class="text-3xl font-bold tracking-tight text-base-content mb-8">Checkout</h1>

        <form method="post" id="checkout-form" class="lg:grid lg:grid-cols-2 lg:gap-x-12">
            {% csrf_token %}
            
            <!-- Left Column - Customer Information -->
            <div>
                <!-- Contact Information -->
                <div class="card bg-base-100 shadow-sm mb-6">
                    <div class="card-body">
                        <h2 class="card-title">Contact Information</h2>
                        
                        <div class="form-control">
                            <label for="email" class="label">
                                <span class="label-text">Email address</span>
                            </label>
                            <input type="email" id="email" name="email" required 
                                   autocomplete="email" 
                                   class="input input-bordered w-full" 
                                   placeholder="your@email.com"
                                   {% if user.is_authenticated %}value="{{ user.email }}"{% endif %}>
                        </div>
                    </div>
                </div>

                <!-- Shipping Information -->
                <div class="card bg-base-100 shadow-sm mb-6">
                    <div class="card-body">
                        <h2 class="card-title">Shipping Information</h2>

                        {% if user.is_authenticated %}
                            {% if saved_addresses %}
                            <div class="form-control mb-4">
                                <label for="saved_address" class="label">
                                    <span class="label-text">Use saved address</span>
                                </label>
                                <select id="saved_address" name="saved_address" class="select select-bordered w-full">
                                    <option value="">-- Enter new address --</option>
                                    {% for address in saved_addresses %}
                                    <option value="{{ address.id }}" 
                                        data-recipient-name="{{ address.recipient_name }}"
                                        data-address-line1="{{ address.address_line1 }}"
                                        data-address-line2="{{ address.address_line2|default:'' }}"
                                        data-city="{{ address.city }}"
                                        data-state="{{ address.state }}"
                                        data-postal-code="{{ address.postal_code }}"
                                        data-phone="{{ address.phone|default:'' }}"
                                        {% if address.is_default %}selected{% endif %}>
                                        {{ address.label|default:address.get_address_type_display }} - {{ address.recipient_name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <label class="label">
                                    <span class="label-text-alt">
                                        <a href="{% url 'customer_portal:address_list' %}" class="link link-primary">Manage addresses</a>
                                    </span>
                                </label>
                            </div>
                            
                            <div class="divider">OR</div>
                            {% endif %}
                        {% endif %}

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-control">
                                <label for="first_name" class="label">
                                    <span class="label-text">First name</span>
                                </label>
                                <input type="text" id="first_name" name="first_name" required 
                                       autocomplete="given-name" 
                                       class="input input-bordered w-full">
                            </div>
                            
                            <div class="form-control">
                                <label for="last_name" class="label">
                                    <span class="label-text">Last name</span>
                                </label>
                                <input type="text" id="last_name" name="last_name" required 
                                       autocomplete="family-name" 
                                       class="input input-bordered w-full">
                            </div>
                        </div>

                        <div class="form-control">
                            <label for="address" class="label">
                                <span class="label-text">Address</span>
                            </label>
                            <input type="text" name="address" id="address" required 
                                   autocomplete="street-address" 
                                   class="input input-bordered w-full" 
                                   placeholder="123 Main St">
                        </div>

                        <div class="form-control">
                            <label for="apartment" class="label">
                                <span class="label-text">Apartment, suite, etc. (optional)</span>
                            </label>
                            <input type="text" name="apartment" id="apartment" 
                                   class="input input-bordered w-full" 
                                   placeholder="Apt 4B">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-control">
                                <label for="city" class="label">
                                    <span class="label-text">City</span>
                                </label>
                                <input type="text" name="city" id="city" required 
                                       autocomplete="address-level2" 
                                       class="input input-bordered w-full">
                            </div>

                            <div class="form-control">
                                <label for="state" class="label">
                                    <span class="label-text">State / Province</span>
                                </label>
                                <input type="text" name="state" id="state" required 
                                       autocomplete="address-level1" 
                                       class="input input-bordered w-full">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-control">
                                <label for="postal-code" class="label">
                                    <span class="label-text">ZIP / Postal code</span>
                                </label>
                                <input type="text" name="postal-code" id="postal-code" required 
                                       autocomplete="postal-code" 
                                       class="input input-bordered w-full">
                            </div>

                            <div class="form-control">
                                <label for="phone" class="label">
                                    <span class="label-text">Phone (optional)</span>
                                </label>
                                <input type="tel" name="phone" id="phone" 
                                       autocomplete="tel" 
                                       class="input input-bordered w-full">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Information -->
                <div class="card bg-base-100 shadow-sm mb-6">
                    <div class="card-body">
                        <h2 class="card-title">Payment</h2>

                        <div class="alert alert-info mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span>Payment processing is in demo mode. No charges will be made.</span>
                        </div>

                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Card details</span>
                            </label>
                            <div class="space-y-2">
                                <input type="text" placeholder="Card number" 
                                       value="4242 4242 4242 4242" 
                                       class="input input-bordered w-full" readonly>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="text" placeholder="MM / YY" 
                                           value="12/34" 
                                           class="input input-bordered" readonly>
                                    <input type="text" placeholder="CVC" 
                                           value="123" 
                                           class="input input-bordered" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Notes -->
                <div class="card bg-base-100 shadow-sm">
                    <div class="card-body">
                        <h2 class="card-title text-lg">Additional Information</h2>
                        
                        <div class="form-control">
                            <label for="notes" class="label">
                                <span class="label-text">Order notes (optional)</span>
                            </label>
                            <textarea id="notes" name="notes" rows="3" 
                                      class="textarea textarea-bordered" 
                                      placeholder="Special instructions for your order..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Order Summary -->
            <div class="mt-10 lg:mt-0">
                <div class="card bg-base-100 shadow-sm sticky top-24">
                    <div class="card-body">
                        <h2 class="card-title mb-4">Order Summary</h2>

                        <div class="space-y-4 max-h-96 overflow-y-auto">
                            {% for item in cart.items.all %}
                            <div class="flex space-x-4">
                                <div class="flex-shrink-0">
                                    <div class="w-20 h-20 rounded-lg bg-base-200 overflow-hidden">
                                        {% if item.product.main_image %}
                                        <img src="{{ item.product.main_image.url }}" 
                                             alt="{{ item.product.name }}" 
                                             class="w-full h-full object-cover">
                                        {% elif item.product.images.all %}
                                        {% with item.product.images.all.0 as first_image %}
                                        <img src="{{ first_image.image.url }}" 
                                             alt="{{ item.product.name }}" 
                                             class="w-full h-full object-cover">
                                        {% endwith %}
                                        {% else %}
                                        <div class="w-full h-full flex items-center justify-center">
                                            <svg class="w-8 h-8 text-base-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="flex-1">
                                    <h3 class="text-sm font-medium">{{ item.product.name }}</h3>
                                    {% if item.selected_options %}
                                    <p class="text-xs text-base-content/60 mt-1">
                                        {% for key, value in item.selected_options.items %}
                                            {{ key }}: {{ value }}{% if not forloop.last %}, {% endif %}
                                        {% endfor %}
                                    </p>
                                    {% endif %}
                                    <p class="text-sm text-base-content/60 mt-1">Qty: {{ item.quantity }}</p>
                                </div>
                                
                                <div class="text-right">
                                    <p class="text-sm font-medium">${{ item.line_total|floatformat:2 }}</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <div class="divider"></div>

                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span>Subtotal</span>
                                <span>${{ cart.subtotal|floatformat:2 }}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>Shipping</span>
                                <span class="text-success">Free</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>Tax</span>
                                <span>Calculated at next step</span>
                            </div>
                        </div>

                        <div class="divider"></div>

                        <div class="flex justify-between text-lg font-bold">
                            <span>Total</span>
                            <span class="text-primary">${{ cart.subtotal|floatformat:2 }}</span>
                        </div>

                        <button type="submit" class="btn btn-primary btn-block btn-lg mt-6">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Place Order
                        </button>
                        
                        <div class="text-center mt-4">
                            <a href="{% url 'shop:cart' %}" class="link link-hover text-sm">
                                ← Return to cart
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
// Handle saved address selection
document.getElementById('saved_address')?.addEventListener('change', function() {
    const selected = this.options[this.selectedIndex];
    
    if (selected.value) {
        // Fill in the form with saved address data
        document.getElementById('first_name').value = selected.dataset.recipientName?.split(' ')[0] || '';
        document.getElementById('last_name').value = selected.dataset.recipientName?.split(' ').slice(1).join(' ') || '';
        document.getElementById('address').value = selected.dataset.addressLine1 || '';
        document.getElementById('apartment').value = selected.dataset.addressLine2 || '';
        document.getElementById('city').value = selected.dataset.city || '';
        document.getElementById('state').value = selected.dataset.state || '';
        document.getElementById('postal-code').value = selected.dataset.postalCode || '';
        document.getElementById('phone').value = selected.dataset.phone || '';
    } else {
        // Clear the form
        document.getElementById('first_name').value = '';
        document.getElementById('last_name').value = '';
        document.getElementById('address').value = '';
        document.getElementById('apartment').value = '';
        document.getElementById('city').value = '';
        document.getElementById('state').value = '';
        document.getElementById('postal-code').value = '';
        document.getElementById('phone').value = '';
    }
});

// Auto-fill if default address is selected
window.addEventListener('DOMContentLoaded', function() {
    const savedAddress = document.getElementById('saved_address');
    if (savedAddress && savedAddress.value) {
        savedAddress.dispatchEvent(new Event('change'));
    }
});
</script>

{% endblock %}